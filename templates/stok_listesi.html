{% extends "base_layout.html" %}

{% block title %}Stok Listesi{% endblock %}

{% block head %}
<!-- Additional CSS for dataTables -->
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
        margin-bottom: 20px;
        border: none;
    }

    .card-header {
        background-color: #f8f9fa;
        font-weight: 600;
        padding: 15px 20px;
        border-radius: 10px 10px 0 0 !important;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        margin-bottom: 10px;
    }

    .group-header {
        background-color: #e9ecef;
        font-weight: bold;
        padding: 8px;
        cursor: pointer;
    }

    .group-header:hover {
        background-color: #dee2e6;
    }

    .group-content {
        display: none;
    }

    .group-content.show {
        display: table-row-group;
    }

    .summary-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    /* Filter card styling */
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .form-select, .form-control {
        border-radius: 6px;
    }

    /* Custom Dropdown with Checkboxes */
    .filter-dropdown {
        position: relative;
        width: 100%;
    }

    .filter-dropdown-toggle {
        width: 100%;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        cursor: pointer;
        text-align: left;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .filter-dropdown-toggle:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .filter-dropdown-toggle.filtered {
        border-color: #0d6efd;
        background-color: #f0f8ff;
    }

    .filter-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        display: none;
        width: 100%;
        max-height: 250px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        margin-top: 2px;
    }

    .filter-dropdown-menu.show {
        display: block;
    }

    .filter-dropdown-header {
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-dropdown-search {
        width: 100%;
        padding: 0.25rem 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        margin: 0.5rem;
        width: calc(100% - 1rem);
    }

    .filter-dropdown-item {
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
    }

    .filter-dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .filter-dropdown-item input[type="checkbox"] {
        margin-right: 0.5rem;
    }

    .filter-dropdown-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .filter-dropdown-item.disabled input[type="checkbox"] {
        cursor: not-allowed;
    }

    .filter-dropdown-item.disabled label {
        cursor: not-allowed;
        color: #6c757d;
    }

    .filter-dropdown-actions {
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 0.5rem;
    }

    .btn-xs {
        padding: 0.125rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
    }

    /* Selection badge */
    .selection-badge {
        background-color: #262262;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 10px;
        margin-left: 0.5rem;
    }

    /* Clear button */
    .clear-selection-btn {
        background: none;
        border: none;
        color: #dc3545;
        font-size: 0.75rem;
        cursor: pointer;
        padding: 0;
        margin-left: 0.25rem;
    }

    .clear-selection-btn:hover {
        color: #b02a37;
    }

    /* Loading indicator */
    .filter-loading {
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    /* Active filter indicators */
    .filter-active-indicator {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 12px;
        height: 12px;
        background-color: #dc3545;
        border-radius: 50%;
        font-size: 8px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    /* Boostrap 5 fix for old BS4 form-select */
    .form-select {
        display: block;
        width: 100%;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        appearance: none;
    }

    .form-control.filtered {
        border-color: #0d6efd;
        background-color: #f0f8ff;
    }
</style>
{% endblock %}

{% block content %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="m-0 font-weight-bold">
            Filtreler
            <small class="text-muted">(Otomatik filtreleme aktif)</small>
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-2 mb-3">
                <label>Ana Grup</label>
                <div class="filter-dropdown" data-field="anaGrup">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Ana Grup Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label>Alt Grup</label>
                <div class="filter-dropdown" data-field="altGrup">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Alt Grup Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label>Kalınlık</label>
                <div class="filter-dropdown" data-field="kalinlik">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Kalınlık Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label>Yükseklik</label>
                <div class="filter-dropdown" data-field="yukseklik">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Yükseklik Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label>En</label>
                <div class="filter-dropdown" data-field="en">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>En Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label>Boy</label>
                <div class="filter-dropdown" data-field="boy">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Boy Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label>Kalite</label>
                <div class="filter-dropdown" data-field="kalite">
                    <div class="filter-dropdown-toggle" tabindex="0">
                        Tümü
                        <div class="filter-loading"></div>
                    </div>
                    <div class="filter-dropdown-menu">
                        <div class="filter-dropdown-header">
                            <span>Kalite Seçin</span>
                            <button type="button" class="clear-selection-btn" title="Temizle">✕</button>
                        </div>
                        <input type="text" class="filter-dropdown-search" placeholder="Ara...">
                        <div class="filter-dropdown-items">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                        <div class="filter-dropdown-actions">
                            <button type="button" class="btn btn-primary btn-xs select-all-btn">Tümünü Seç</button>
                            <button type="button" class="btn btn-secondary btn-xs deselect-all-btn">Tümünü Kaldır</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label for="filterStokAdi">Stok Adı</label>
                <input type="text" id="filterStokAdi" class="form-control" placeholder="Stok adı ara...">
            </div>
            <div class="col-md-6 text-end align-self-end">
                <button id="btnResetFilters" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Tüm Filtreleri Sıfırla
                </button>
                <small class="text-muted d-block mt-1">Filtreler otomatik olarak uygulanır</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold">Stok Durumu</h5>
        <div>
            <button class="btn btn-primary" id="btnRefresh">
                <i class="fas fa-sync-alt"></i> Yenile
            </button>
            <button class="btn btn-success" id="btnExcel">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-info" id="btnPrint">
                <i class="fas fa-print"></i> Yazdır
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="stokTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ANA GRUP</th>
                        <th>ALT GRUP</th>
                        <th>STOK ADI</th>
                        <th>KALINLIK</th>
                        <th>YÜKSEKLİK</th>
                        <th>EN</th>
                        <th>BOY</th>
                        <th>KALİTE</th>
                        <th>2.KALİTE</th>
                        <th>DEPO (ADET)</th>
                        <th>REZERVE (ADET)</th>
                        <th>TOP.MİKTAR (ADET)</th>
                        <th>TOP.MİKTAR (KG)</th>
                        <th>NOT</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Veriler AJAX ile yüklenecek -->
                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>DEPO TOPLAM</th>
                        <th>REZERVE TOPLAM</th>
                        <th>MİKTAR TOPLAM</th>
                        <th>KG TOPLAM</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced script for real-time checkbox-based filtering functionality
// Auto-filtering on any selection change

$(document).ready(function() {
    // Variable to store all data
    let allData = [];
    // Variable to store currently filtered data
    let filteredData = [];
    // Variable to store the DataTable instance
    let table;
    // Object to store filter selections
    let filterSelections = {
        anaGrup: [],
        altGrup: [],
        kalinlik: [],
        yukseklik: [],
        en: [],
        boy: [],
        kalite: [],
        stokAdi: ''
    };

    // Debounce timer for text input
    let textFilterTimer = null;

    // Field mappings for easier access
    const fieldMappings = {
        'anaGrup': 'ANA_GRUP',
        'altGrup': 'ALT_GRUP',
        'kalinlik': 'KALINLIK',
        'yukseklik': 'YUKSEKLIK',
        'en': 'EN',
        'boy': 'BOY',
        'kalite': 'KALITE'
    };

    // Initial data load and select population
    $.ajax({
        url: '/stok-listesi/data',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            // Store all data
            allData = data;
            filteredData = data;

            // Initialize the DataTable with all data
            initializeDataTable(data);

            // Populate filter dropdowns with all values initially
            populateAllFilterDropdowns(data);

            // Setup filter dropdown event handlers
            setupFilterDropdownHandlers();

            // Setup real-time text filtering
            setupTextFiltering();
        },
        error: function(xhr, status, error) {
            console.error("Error loading data:", error);
            alert("Veri yüklenirken bir hata oluştu: " + error);
        }
    });

    // Function to initialize the DataTable
    function initializeDataTable(data) {
        // Create DataTable with grouping
        table = $('#stokTable').DataTable({
            "data": data,
            "columns": [
                { "data": "ANA_GRUP" },
                { "data": "ALT_GRUP" },
                { "data": "STOK_ADI" },
                { "data": "KALINLIK" },
                { "data": "YUKSEKLIK" },
                { "data": "EN" },
                { "data": "BOY" },
                { "data": "KALITE" },
                { "data": "KALITE2" },
                { "data": "DEPO_ADET", "render": $.fn.dataTable.render.number('.', ',', 0) },
                { "data": "REZERVE_ADET", "render": $.fn.dataTable.render.number('.', ',', 0) },
                { "data": "TOPLAM_MIKTAR_ADET", "render": $.fn.dataTable.render.number('.', ',', 0) },
                { "data": "TOPLAM_MIKTAR_KG", "render": $.fn.dataTable.render.number('.', ',', 2) },
                { "data": "NOT" }
            ],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json"
            },
            "order": [[0, "asc"]],
            "pageLength": 100,
            "lengthMenu": [[25, 50, 100, 250, 500, 1000, -1], [25, 50, 100, 250, 500, 1000, "Tümü"]],
            "rowGroup": {
                "dataSrc": "ANA_GRUP",
                "startRender": function(rows, group) {
                    var depoTotal = rows
                        .data()
                        .pluck('DEPO_ADET')
                        .reduce(function(a, b) { return a + b; }, 0);

                    var rezerveTotal = rows
                        .data()
                        .pluck('REZERVE_ADET')
                        .reduce(function(a, b) { return a + b; }, 0);

                    var miktarTotal = rows
                        .data()
                        .pluck('TOPLAM_MIKTAR_ADET')
                        .reduce(function(a, b) { return a + b; }, 0);

                    var kgTotal = rows
                        .data()
                        .pluck('TOPLAM_MIKTAR_KG')
                        .reduce(function(a, b) { return a + b; }, 0);

                    return $('<tr/>')
                        .append('<td colspan="9"><strong>' + group + '</strong></td>')
                        .append('<td><strong>' + depoTotal.toLocaleString('tr-TR') + '</strong></td>')
                        .append('<td><strong>' + rezerveTotal.toLocaleString('tr-TR') + '</strong></td>')
                        .append('<td><strong>' + miktarTotal.toLocaleString('tr-TR') + '</strong></td>')
                        .append('<td><strong>' + kgTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</strong></td>')
                        .append('<td></td>');
                }
            },
            "footerCallback": function(row, data, start, end, display) {
                var api = this.api();

                // Total values for each column
                var pageTotal = api
                    .column(9, { page: 'current' })
                    .data()
                    .reduce(function(a, b) { return a + b; }, 0);

                $(api.column(9).footer()).html('Toplam: ' + pageTotal.toLocaleString('tr-TR'));

                // Rezerve adet column
                pageTotal = api
                    .column(10, { page: 'current' })
                    .data()
                    .reduce(function(a, b) { return a + b; }, 0);

                $(api.column(10).footer()).html('Toplam: ' + pageTotal.toLocaleString('tr-TR'));

                // Toplam miktar adet column
                pageTotal = api
                    .column(11, { page: 'current' })
                    .data()
                    .reduce(function(a, b) { return a + b; }, 0);

                $(api.column(11).footer()).html('Toplam: ' + pageTotal.toLocaleString('tr-TR'));

                // Toplam miktar kg column
                pageTotal = api
                    .column(12, { page: 'current' })
                    .data()
                    .reduce(function(a, b) { return a + b; }, 0);

                $(api.column(12).footer()).html('Toplam: ' + pageTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            },
            "dom": 'Blfrtip',
            "buttons": [
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    title: 'Stok Listesi',
                    className: 'btn btn-success d-none',
                    exportOptions: {
                        columns: ':visible',
                        format: {
                            body: function(data, row, column, node) {
                                // Sayısal sütunlar (9,10,11,12. sütunlar) için binlik ayırıcıları temizle
                                if (column === 9 || column === 10 || column === 11 || column === 12) {
                                    // Binlik ayırıcıları kaldır ve sayıya çevir
                                    var cleanValue = data.replace(/\./g, '').replace(/,/g, '.');
                                    var numValue = parseFloat(cleanValue);
                                    return isNaN(numValue) ? 0 : numValue;
                                }
                                return data;
                            }
                        }
                    }
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> Yazdır',
                    title: 'Stok Listesi',
                    className: 'btn btn-info d-none',
                    exportOptions: {
                        columns: ':visible'
                    },
                    customize: function(win) {
                        $(win.document.body).css('font-size', '10pt');
                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit');
                    }
                }
            ]
        });

        // Reset filters button event handler
        $('#btnResetFilters').on('click', function() {
            resetFilters();
        });

        // Excel and Print button event handlers
        $('#btnExcel').on('click', function() {
            $('.buttons-excel').click();
        });

        $('#btnPrint').on('click', function() {
            $('.buttons-print').click();
        });

        // Refresh button
        $('#btnRefresh').on('click', function() {
            $.ajax({
                url: '/stok-listesi/data',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    allData = data;
                    filteredData = data;
                    table.clear().rows.add(data).draw();
                    populateAllFilterDropdowns(data);
                    resetFilters();
                },
                error: function(xhr, status, error) {
                    console.error("Error refreshing data:", error);
                    alert("Veri yenilenirken bir hata oluştu: " + error);
                }
            });
        });
    }

    // Function to setup real-time text filtering
    function setupTextFiltering() {
        $('#filterStokAdi').on('input', function() {
            const value = $(this).val();

            // Clear previous timer
            if (textFilterTimer) {
                clearTimeout(textFilterTimer);
            }

            // Set new timer for debounced filtering
            textFilterTimer = setTimeout(function() {
                filterSelections.stokAdi = value;
                applyFiltersRealTime('stokAdi');
                updateTextFilterIndicator('#filterStokAdi', value);
            }, 300); // 300ms delay
        });
    }

    // Function to setup filter dropdown handlers
    function setupFilterDropdownHandlers() {
        // Toggle dropdown visibility
        $(document).on('click', '.filter-dropdown-toggle', function(e) {
            e.stopPropagation();
            var $dropdown = $(this).closest('.filter-dropdown');
            var $menu = $dropdown.find('.filter-dropdown-menu');

            // Close all other dropdowns
            $('.filter-dropdown-menu').not($menu).removeClass('show');

            // Toggle current dropdown
            $menu.toggleClass('show');
        });

        // Close dropdowns when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.filter-dropdown').length) {
                $('.filter-dropdown-menu').removeClass('show');
            }
        });

        // Prevent dropdown from closing when clicking inside menu
        $(document).on('click', '.filter-dropdown-menu', function(e) {
            e.stopPropagation();
        });

        // Search functionality
        $(document).on('input', '.filter-dropdown-search', function() {
            var searchTerm = $(this).val().toLowerCase();
            var $items = $(this).closest('.filter-dropdown-menu').find('.filter-dropdown-item');

            $items.each(function() {
                var text = $(this).find('label').text().toLowerCase();
                $(this).toggle(text.includes(searchTerm));
            });
        });

        // Checkbox change handler - Real-time filtering
        $(document).on('change', '.filter-dropdown-item input[type="checkbox"]', function() {
            var $dropdown = $(this).closest('.filter-dropdown');
            var field = $dropdown.data('field');

            updateDropdownDisplay($dropdown, field);

            // Apply filters immediately with trigger field info
            applyFiltersRealTime(field);
        });

        // Select All button
        $(document).on('click', '.select-all-btn', function() {
            var $dropdown = $(this).closest('.filter-dropdown');
            var $checkboxes = $dropdown.find('.filter-dropdown-item input[type="checkbox"]:visible:not(:disabled)');
            $checkboxes.prop('checked', true);
            var field = $dropdown.data('field');
            updateDropdownDisplay($dropdown, field);
            applyFiltersRealTime(field);
        });

        // Deselect All button
        $(document).on('click', '.deselect-all-btn', function() {
            var $dropdown = $(this).closest('.filter-dropdown');
            var $checkboxes = $dropdown.find('.filter-dropdown-item input[type="checkbox"]');
            $checkboxes.prop('checked', false);
            var field = $dropdown.data('field');
            updateDropdownDisplay($dropdown, field);
            applyFiltersRealTime(field);
        });

        // Clear selection button
        $(document).on('click', '.clear-selection-btn', function() {
            var $dropdown = $(this).closest('.filter-dropdown');
            var $checkboxes = $dropdown.find('.filter-dropdown-item input[type="checkbox"]');
            $checkboxes.prop('checked', false);
            var field = $dropdown.data('field');
            updateDropdownDisplay($dropdown, field);
            $dropdown.find('.filter-dropdown-menu').removeClass('show');
            applyFiltersRealTime(field);
        });
    }

    // Function to populate all filter dropdowns
    function populateAllFilterDropdowns(data) {
        Object.keys(fieldMappings).forEach(function(field) {
            populateFilterDropdown(field, data);
        });
    }

    // Function to populate a specific filter dropdown
    function populateFilterDropdown(field, data) {
        var $dropdown = $('.filter-dropdown[data-field="' + field + '"]');
        var $itemsContainer = $dropdown.find('.filter-dropdown-items');
        var dataField = fieldMappings[field];

        // Extract unique values
        var values = [...new Set(data.map(item => item[dataField]).filter(val => val))].sort();

        // Clear existing items
        $itemsContainer.empty();

        // Add checkbox items
        values.forEach(function(value) {
            var isChecked = filterSelections[field].includes(value);
            var $item = $(`
                <div class="filter-dropdown-item">
                    <input type="checkbox" id="${field}_${value}_${Date.now()}" value="${value}" ${isChecked ? 'checked' : ''}>
                    <label for="${field}_${value}_${Date.now()}">${value}</label>
                </div>
            `);
            $itemsContainer.append($item);
        });

        // Update display
        updateDropdownDisplay($dropdown, field);
    }

    // Function to update dropdown display text
    function updateDropdownDisplay($dropdown, field) {
        var $toggle = $dropdown.find('.filter-dropdown-toggle');
        var $checkboxes = $dropdown.find('.filter-dropdown-item input[type="checkbox"]:checked');
        var selectedValues = [];

        $checkboxes.each(function() {
            selectedValues.push($(this).val());
        });

        // Update filter selections
        filterSelections[field] = selectedValues;

        // Update display text and visual indicators
        if (selectedValues.length === 0) {
            $toggle.html('Tümü <div class="filter-loading"></div>');
            $toggle.removeClass('filtered');
        } else if (selectedValues.length === 1) {
            $toggle.html(selectedValues[0] + ' <div class="filter-loading"></div>');
            $toggle.addClass('filtered');
        } else {
            $toggle.html(selectedValues.length + ' adet seçili <span class="selection-badge">' + selectedValues.length + '</span> <div class="filter-loading"></div>');
            $toggle.addClass('filtered');
        }
    }

    // Function to update text filter indicator
    function updateTextFilterIndicator(selector, value) {
        var $input = $(selector);
        if (value && value.trim()) {
            $input.addClass('filtered');
        } else {
            $input.removeClass('filtered');
        }
    }

    // Function to show loading indicator
    function showLoadingIndicator($dropdown) {
        $dropdown.find('.filter-loading').show();
    }

    // Function to hide loading indicator
    function hideLoadingIndicator($dropdown) {
        $dropdown.find('.filter-loading').hide();
    }

    // Function to apply filters in real-time
    function applyFiltersRealTime(triggerField = null) {
        // Show loading indicators on all filters
        $('.filter-dropdown').each(function() {
            showLoadingIndicator($(this));
        });

        // Small delay to show loading effect
        setTimeout(function() {
            applyFilters();

            // Update other filter dropdowns based on current filtered data
            updateDependentFilters(triggerField);

            // Hide all loading indicators
            $('.filter-dropdown').each(function() {
                hideLoadingIndicator($(this));
            });
        }, 100);
    }

    // Function to apply filters
    function applyFilters() {
        // Filter the data
        filteredData = allData.filter(function(item) {
            // Check each filter condition
            for (let field in fieldMappings) {
                let dataField = fieldMappings[field];
                if (filterSelections[field].length > 0 && !filterSelections[field].includes(item[dataField])) {
                    return false;
                }
            }

            // Check stok adı filter
            if (filterSelections.stokAdi && !item.STOK_ADI.toLowerCase().includes(filterSelections.stokAdi.toLowerCase())) {
                return false;
            }

            return true;
        });

        // Update the data table
        table.clear().rows.add(filteredData).draw();
    }

    // Function to update dependent filters based on current filtered data
    function updateDependentFilters(triggerField) {
        // For each filter field, update options based on current filteredData
        Object.keys(fieldMappings).forEach(function(field) {
            // Skip the field that triggered this update
            if (field === triggerField) {
                return;
            }

            var $dropdown = $('.filter-dropdown[data-field="' + field + '"]');
            var $itemsContainer = $dropdown.find('.filter-dropdown-items');
            var dataField = fieldMappings[field];

            // Get current selections for this field
            var currentSelections = filterSelections[field];

            // Calculate available values based on current filtered data
            // (excluding the current field's filter to show what's available)
            var availableData = allData.filter(function(item) {
                for (let otherField in fieldMappings) {
                    if (otherField === field) continue; // Skip current field

                    let otherDataField = fieldMappings[otherField];
                    if (filterSelections[otherField].length > 0 && !filterSelections[otherField].includes(item[otherDataField])) {
                        return false;
                    }
                }

                // Check stok adı filter
                if (filterSelections.stokAdi && !item.STOK_ADI.toLowerCase().includes(filterSelections.stokAdi.toLowerCase())) {
                    return false;
                }

                return true;
            });

            // Extract unique values from available data
            var availableValues = [...new Set(availableData.map(item => item[dataField]).filter(val => val))].sort();

            // Clear existing items
            $itemsContainer.empty();

            // Add checkbox items
            availableValues.forEach(function(value) {
                var isChecked = currentSelections.includes(value);
                var isDisabled = !availableValues.includes(value);
                var uniqueId = field + '_' + value.replace(/[^a-zA-Z0-9]/g, '_') + '_' + Date.now();

                var $item = $(`
                    <div class="filter-dropdown-item ${isDisabled ? 'disabled' : ''}">
                        <input type="checkbox" id="${uniqueId}" value="${value}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <label for="${uniqueId}">${value}</label>
                    </div>
                `);
                $itemsContainer.append($item);
            });

            // Remove invalid selections (values that are no longer available)
            var validSelections = currentSelections.filter(selection => availableValues.includes(selection));
            if (validSelections.length !== currentSelections.length) {
                filterSelections[field] = validSelections;
                updateDropdownDisplay($dropdown, field);
            }
        });
    }

    // Function to reset all filters
    function resetFilters() {
        // Clear all filter selections
        filterSelections = {
            anaGrup: [],
            altGrup: [],
            kalinlik: [],
            yukseklik: [],
            en: [],
            boy: [],
            kalite: [],
            stokAdi: ''
        };

        // Clear stok adı input
        $('#filterStokAdi').val('').removeClass('filtered');

        // Reset DataTable to show all data
        filteredData = allData;
        table.clear().rows.add(allData).draw();

        // Repopulate filter dropdowns with all data
        populateAllFilterDropdowns(allData);

        // Remove filtered class from all dropdowns
        $('.filter-dropdown-toggle').removeClass('filtered');

        // Close all dropdowns
        $('.filter-dropdown-menu').removeClass('show');
    }
});
</script>
{% endblock %}