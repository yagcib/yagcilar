{% extends "base_layout.html" %}

{% block title %}Petrol Barkopos Güncelleme - Yagcilar Holding{% endblock %}

{% block head %}
<style>
    .filter-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .table-container {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-update {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-update:hover {
        background-color: #218838;
    }
    
    .btn-update:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
    
    .btn-logo-transfer {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-logo-transfer:hover {
        background-color: #138496;
    }

    .select-all-container {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
    }

    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }

    .nav-tabs .nav-link.active {
        background-color: #282965;
        color: white;
        border-color: #282965;
    }

    .nav-tabs .nav-link {
        color: #282965;
        border-color: #dee2e6;
    }

    .nav-tabs .nav-link:hover {
        border-color: #282965;
        color: #282965;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-barcode me-2"></i>
                        Petrol Barkopos Güncelleme
                    </h4>
                    <!-- Logo'ya Veri Aktar button -->
                    <div class="float-end">
                        <button type="button" class="btn btn-sm btn-outline-info me-2"
                                onclick="checkBarkoFiles()">
                            <i class="fas fa-search me-1"></i>Dosya Kontrol
                        </button>
                        <button type="button" class="btn btn-sm btn-logo-transfer me-2"
                                onclick="transferDataToLogo()" id="transferBtn">
                            <i class="fas fa-upload me-1"></i>Logo'ya Veri Aktar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger"
                                onclick="stopTransferProcess()" id="stopBtn" style="display: none;">
                            <i class="fas fa-stop me-1"></i>İşlemi Durdur
                        </button>
                    </div>

                    <!-- Transfer Status Display -->
                    <div id="transferStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                <strong>Aktarım İşlemi Devam Ediyor...</strong>
                                <div class="mt-1">
                                    <small id="transferElapsedTime">Geçen süre: 0 saniye</small>
                                </div>
                                <div class="mt-1">
                                    <small id="transferExePath"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs" id="barkoposTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="z-rapor-tab" data-bs-toggle="tab"
                                    data-bs-target="#z-rapor" type="button" role="tab"
                                    aria-controls="z-rapor" aria-selected="true">
                                <i class="fas fa-file-alt me-2"></i>Z Rapor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="giris-irsaliye-tab" data-bs-toggle="tab"
                                    data-bs-target="#giris-irsaliye" type="button" role="tab"
                                    aria-controls="giris-irsaliye" aria-selected="false">
                                <i class="fas fa-truck me-2"></i>Giriş İrsaliyesi
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="barkoposTabContent">
                        <!-- Z Rapor Tab -->
                        <div class="tab-pane fade show active" id="z-rapor" role="tabpanel"
                             aria-labelledby="z-rapor-tab">
                            <div class="mt-3">
                                <!-- Filters -->
                                <div class="filter-container">
                                    <h5 class="mb-3">
                                        <i class="fas fa-filter me-2"></i>Filtreler
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="zRaporTarihFiltre" class="form-label">Tarih</label>
                                            <input type="date" class="form-control" id="zRaporTarihFiltre">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="zRaporEvrakIdFiltre" class="form-label">Evrak No</label>
                                            <input type="text" class="form-control" id="zRaporEvrakIdFiltre"
                                                   placeholder="Evrak numarası">
                                        </div>
                                        <div class="col-md-4 d-flex align-items-end">
                                            <button type="button" class="btn btn-primary me-2"
                                                    onclick="loadZRaporData()">
                                                <i class="fas fa-search me-2"></i>Filtrele
                                            </button>
                                            <button type="button" class="btn btn-update" id="zRaporGuncelleBtn"
                                                    onclick="updateZRapor()" disabled>
                                                <i class="fas fa-sync me-2"></i>Güncelle
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Table -->
                                <div class="table-container">
                                    <div class="select-all-container">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   id="zRaporSelectAll" onchange="toggleAllZRapor()">
                                            <label class="form-check-label" for="zRaporSelectAll">
                                                <strong>Tümünü Seç</strong>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="loading-spinner" id="zRaporLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Veriler yükleniyor...</p>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="zRaporTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th width="40">Seç</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak No</th>
                                                    <th>Stok Kodu</th>
                                                    <th>Stok Adı</th>
                                                    <th>Miktar</th>
                                                    <th>KDV</th>
                                                    <th>Fiyat</th>
                                                </tr>
                                            </thead>
                                            <tbody id="zRaporTableBody">
                                                <tr>
                                                    <td colspan="8" class="text-center text-muted py-4">
                                                        Filtreleme yaparak verileri görüntüleyin
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Giriş İrsaliyesi Tab -->
                        <div class="tab-pane fade" id="giris-irsaliye" role="tabpanel"
                             aria-labelledby="giris-irsaliye-tab">
                            <div class="mt-3">
                                <!-- Filters -->
                                <div class="filter-container">
                                    <h5 class="mb-3">
                                        <i class="fas fa-filter me-2"></i>Filtreler
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="girisIrsaliyeTarihFiltre" class="form-label">Tarih</label>
                                            <input type="date" class="form-control" id="girisIrsaliyeTarihFiltre">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="girisIrsaliyeCariFiltre" class="form-label">Cari</label>
                                            <input type="text" class="form-control" id="girisIrsaliyeCariFiltre"
                                                   placeholder="Cari adı">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="girisIrsaliyeEvrakIdFiltre" class="form-label">Evrak No</label>
                                            <input type="text" class="form-control" id="girisIrsaliyeEvrakIdFiltre"
                                                   placeholder="Evrak numarası">
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button type="button" class="btn btn-primary me-2"
                                                    onclick="loadGirisIrsaliyeData()">
                                                <i class="fas fa-search me-2"></i>Filtrele
                                            </button>
                                            <button type="button" class="btn btn-update" id="girisIrsaliyeGuncelleBtn"
                                                    onclick="updateGirisIrsaliye()" disabled>
                                                <i class="fas fa-sync me-2"></i>Güncelle
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Table -->
                                <div class="table-container">
                                    <div class="select-all-container">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   id="girisIrsaliyeSelectAll" onchange="toggleAllGirisIrsaliye()">
                                            <label class="form-check-label" for="girisIrsaliyeSelectAll">
                                                <strong>Tümünü Seç</strong>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="loading-spinner" id="girisIrsaliyeLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Veriler yükleniyor...</p>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="girisIrsaliyeTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th width="40">Seç</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak No</th>
                                                    <th>Cari</th>
                                                    <th>Stok Kodu</th>
                                                    <th>Stok Adı</th>
                                                    <th>Miktar</th>
                                                    <th>KDV</th>
                                                    <th>Fiyat</th>
                                                </tr>
                                            </thead>
                                            <tbody id="girisIrsaliyeTableBody">
                                                <tr>
                                                    <td colspan="9" class="text-center text-muted py-4">
                                                        Filtreleme yaparak verileri görüntüleyin
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let zRaporData = [];
let girisIrsaliyeData = [];
let transferPollingInterval = null;

// Page load
$(document).ready(function() {
    console.log('DEBUG - Page loaded');

    // Tab change event
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = $(e.target).attr("data-bs-target");
        console.log('DEBUG - Tab changed to:', target);
        if (target === "#z-rapor") {
            loadZRaporData();
        } else if (target === "#giris-irsaliye") {
            loadGirisIrsaliyeData();
        }
    });

    // Load initial data
    console.log('DEBUG - Loading initial Z Rapor data...');
    loadZRaporData();

    // Check for ongoing transfer process on page load
    checkTransferStatus();
});

// Z Rapor Functions
function loadZRaporData() {
    const tarihFiltre = $('#zRaporTarihFiltre').val();
    const evrakIdFiltre = $('#zRaporEvrakIdFiltre').val();

    console.log('DEBUG - Z Rapor filters:', {tarih: tarihFiltre, evrak_id: evrakIdFiltre});

    $('#zRaporLoading').show();
    $('#zRaporTableBody').html('<tr><td colspan="8" class="text-center">Yükleniyor...</td></tr>');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/z-rapor-data',
        method: 'GET',
        data: {
            tarih_filtre: tarihFiltre,
            evrak_id_filtre: evrakIdFiltre
        },
        success: function(response) {
            console.log('DEBUG - Z Rapor response:', response);
            $('#zRaporLoading').hide();
            if (response.success) {
                zRaporData = response.data;
                console.log('DEBUG - Z Rapor data count:', zRaporData.length);
                renderZRaporTable();
            } else {
                console.error('DEBUG - Z Rapor error:', response.error);
                showAlert('danger', 'Hata: ' + response.error);
                $('#zRaporTableBody').html('<tr><td colspan="8" class="text-center text-danger">Veri yüklenirken hata oluştu</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('DEBUG - Z Rapor AJAX error:', {xhr, status, error});
            $('#zRaporLoading').hide();
            showAlert('danger', 'Sunucu hatası oluştu: ' + error);
            $('#zRaporTableBody').html('<tr><td colspan="8" class="text-center text-danger">Sunucu hatası</td></tr>');
        }
    });
}

function renderZRaporTable() {
    console.log('DEBUG - Rendering Z Rapor table with', zRaporData.length, 'items');

    const tbody = $('#zRaporTableBody');
    tbody.empty();

    if (zRaporData.length === 0) {
        tbody.html('<tr><td colspan="8" class="text-center text-muted">Veri bulunamadı</td></tr>');
        console.log('DEBUG - No Z Rapor data to display');
        return;
    }

    zRaporData.forEach((item, index) => {
        const row = `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input z-rapor-checkbox"
                           value="${item.evrak_id}" onchange="updateZRaporButtons()">
                </td>
                <td>${item.tarih}</td>
                <td>${item.evrak_id}</td>
                <td>${item.stok_kodu}</td>
                <td>${item.stok_adi}</td>
                <td>${item.miktar.toFixed(2)}</td>
                <td>${item.kdv.toFixed(2)}%</td>
                <td>${item.fiyat.toFixed(2)} ₺</td>
            </tr>
        `;
        tbody.append(row);
    });

    console.log('DEBUG - Z Rapor table rendered successfully');
    updateZRaporButtons();
}

function toggleAllZRapor() {
    const selectAll = $('#zRaporSelectAll').prop('checked');
    $('.z-rapor-checkbox').prop('checked', selectAll);
    updateZRaporButtons();
}

function updateZRaporButtons() {
    const checkedCount = $('.z-rapor-checkbox:checked').length;
    $('#zRaporGuncelleBtn').prop('disabled', checkedCount === 0);

    // Update select all checkbox
    const totalCount = $('.z-rapor-checkbox').length;
    $('#zRaporSelectAll').prop('checked', checkedCount === totalCount && totalCount > 0);
}

function updateZRapor() {
    const evrakIdFiltre = $('#zRaporEvrakIdFiltre').val();

    if (!evrakIdFiltre) {
        showAlert('warning', 'Güncelleme için Evrak No filtresi gereklidir.');
        return;
    }

    if (!confirm('Seçili kayıtları güncellemek istediğinizden emin misiniz?')) {
        return;
    }

    $('#zRaporGuncelleBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Güncelleniyor...');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/z-rapor-update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            evrak_id: evrakIdFiltre
        }),
        success: function(response) {
            if (response.success) {
                showAlert('success', response.message);
                loadZRaporData(); // Reload data
            } else {
                showAlert('danger', response.message);
            }
        },
        error: function() {
            showAlert('danger', 'Güncelleme sırasında sunucu hatası oluştu');
        },
        complete: function() {
            $('#zRaporGuncelleBtn').prop('disabled', false).html('<i class="fas fa-sync me-2"></i>Güncelle');
        }
    });
}

// Giriş İrsaliyesi Functions
function loadGirisIrsaliyeData() {
    const tarihFiltre = $('#girisIrsaliyeTarihFiltre').val();
    const cariFiltre = $('#girisIrsaliyeCariFiltre').val();
    const evrakIdFiltre = $('#girisIrsaliyeEvrakIdFiltre').val();

    console.log('DEBUG - Giriş İrsaliye filters:', {tarih: tarihFiltre, cari: cariFiltre, evrak_id: evrakIdFiltre});

    $('#girisIrsaliyeLoading').show();
    $('#girisIrsaliyeTableBody').html('<tr><td colspan="9" class="text-center">Yükleniyor...</td></tr>');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/giris-irsaliye-data',
        method: 'GET',
        data: {
            tarih_filtre: tarihFiltre,
            cari_filtre: cariFiltre,
            evrak_id_filtre: evrakIdFiltre
        },
        success: function(response) {
            console.log('DEBUG - Giriş İrsaliye response:', response);
            $('#girisIrsaliyeLoading').hide();
            if (response.success) {
                girisIrsaliyeData = response.data;
                console.log('DEBUG - Giriş İrsaliye data count:', girisIrsaliyeData.length);
                renderGirisIrsaliyeTable();
            } else {
                console.error('DEBUG - Giriş İrsaliye error:', response.error);
                showAlert('danger', 'Hata: ' + response.error);
                $('#girisIrsaliyeTableBody').html('<tr><td colspan="9" class="text-center text-danger">Veri yüklenirken hata oluştu</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('DEBUG - Giriş İrsaliye AJAX error:', {xhr, status, error});
            $('#girisIrsaliyeLoading').hide();
            showAlert('danger', 'Sunucu hatası oluştu: ' + error);
            $('#girisIrsaliyeTableBody').html('<tr><td colspan="9" class="text-center text-danger">Sunucu hatası</td></tr>');
        }
    });
}

function renderGirisIrsaliyeTable() {
    console.log('DEBUG - Rendering Giriş İrsaliye table with', girisIrsaliyeData.length, 'items');

    const tbody = $('#girisIrsaliyeTableBody');
    tbody.empty();

    if (girisIrsaliyeData.length === 0) {
        tbody.html('<tr><td colspan="9" class="text-center text-muted">Veri bulunamadı</td></tr>');
        console.log('DEBUG - No Giriş İrsaliye data to display');
        return;
    }

    girisIrsaliyeData.forEach((item, index) => {
        const row = `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input giris-irsaliye-checkbox"
                           value="${item.evrak_id}" onchange="updateGirisIrsaliyeButtons()">
                </td>
                <td>${item.tarih}</td>
                <td>${item.evrak_id}</td>
                <td>${item.cari}</td>
                <td>${item.stok_kodu}</td>
                <td>${item.stok_adi}</td>
                <td>${item.miktar.toFixed(2)}</td>
                <td>${item.kdv.toFixed(2)}%</td>
                <td>${item.fiyat.toFixed(2)} ₺</td>
            </tr>
        `;
        tbody.append(row);
    });

    console.log('DEBUG - Giriş İrsaliye table rendered successfully');
    updateGirisIrsaliyeButtons();
}

function toggleAllGirisIrsaliye() {
    const selectAll = $('#girisIrsaliyeSelectAll').prop('checked');
    $('.giris-irsaliye-checkbox').prop('checked', selectAll);
    updateGirisIrsaliyeButtons();
}

function updateGirisIrsaliyeButtons() {
    const checkedCount = $('.giris-irsaliye-checkbox:checked').length;
    $('#girisIrsaliyeGuncelleBtn').prop('disabled', checkedCount === 0);

    // Update select all checkbox
    const totalCount = $('.giris-irsaliye-checkbox').length;
    $('#girisIrsaliyeSelectAll').prop('checked', checkedCount === totalCount && totalCount > 0);
}

function updateGirisIrsaliye() {
    const evrakIdFiltre = $('#girisIrsaliyeEvrakIdFiltre').val();

    if (!evrakIdFiltre) {
        showAlert('warning', 'Güncelleme için Evrak No filtresi gereklidir.');
        return;
    }

    if (!confirm('Seçili kayıtları güncellemek istediğinizden emin misiniz?')) {
        return;
    }

    $('#girisIrsaliyeGuncelleBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Güncelleniyor...');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/giris-irsaliye-update',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            evrak_id: evrakIdFiltre
        }),
        success: function(response) {
            if (response.success) {
                showAlert('success', response.message);
                loadGirisIrsaliyeData(); // Reload data
            } else {
                showAlert('danger', response.message);
            }
        },
        error: function() {
            showAlert('danger', 'Güncelleme sırasında sunucu hatası oluştu');
        },
        complete: function() {
            $('#girisIrsaliyeGuncelleBtn').prop('disabled', false).html('<i class="fas fa-sync me-2"></i>Güncelle');
        }
    });
}

// Logo'ya Veri Aktar function
function transferDataToLogo() {
    if (!confirm('PetrolLogoTumAktarimlar.exe uygulamasını çalıştırmak istediğinizden emin misiniz?\n\nBu işlem biraz zaman alabilir.')) {
        return;
    }

    // Button'u disable et
    const transferBtn = $('#transferBtn');
    const originalHtml = transferBtn.html();
    transferBtn.prop('disabled', true);
    transferBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Başlatılıyor...');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/transfer-to-logo',
        method: 'POST',
        success: function(response) {
            if (response.success && response.process_started) {
                // Process başarıyla başlatıldı
                showAlert('info', 'Veri aktarım işlemi başlatıldı. Lütfen bekleyiniz...');

                // UI'ı aktarım moduna çevir
                updateTransferUI(true);

                // Polling'i başlat
                startTransferPolling();

                if (response.exe_path) {
                    $('#transferExePath').text('Dosya: ' + response.exe_path);
                }
            } else {
                showAlert('danger', response.message || 'Veri aktarımı başlatılamadı');
                transferBtn.prop('disabled', false);
                transferBtn.html(originalHtml);
            }
        },
        error: function(xhr, status, error) {
            console.error('Logo transfer error:', {xhr, status, error});
            showAlert('danger', 'Veri aktarımı sırasında sunucu hatası oluştu: ' + error);
            transferBtn.prop('disabled', false);
            transferBtn.html(originalHtml);
        }
    });
}

// Transfer polling başlat
function startTransferPolling() {
    if (transferPollingInterval) {
        clearInterval(transferPollingInterval);
    }

    transferPollingInterval = setInterval(function() {
        checkTransferStatus();
    }, 2000); // Her 2 saniyede bir kontrol et
}

// Transfer durumunu kontrol et
function checkTransferStatus() {
    $.ajax({
        url: '/petrol-barkopos-guncelleme/check-process-status',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                if (response.status === 'running') {
                    // Process hala çalışıyor
                    updateTransferUI(true);
                    $('#transferElapsedTime').text('Geçen süre: ' + response.elapsed_time + ' saniye');

                    if (response.exe_path) {
                        $('#transferExePath').text('Dosya: ' + response.exe_path);
                    }
                } else if (response.status === 'completed') {
                    // Process tamamlandı
                    if (transferPollingInterval) {
                        clearInterval(transferPollingInterval);
                        transferPollingInterval = null;
                    }

                    updateTransferUI(false);

                    // Sonuç mesajını göster
                    if (response.return_code === 0) {
                        showAlert('success', 'Veri aktarım işlemi başarıyla tamamlandı!\nGeçen süre: ' + response.elapsed_time + ' saniye');
                    } else {
                        showAlert('warning', 'Veri aktarım işlemi tamamlandı ancak hata kodu döndü.\nGeçen süre: ' + response.elapsed_time + ' saniye\nÇıkış kodu: ' + response.return_code);
                    }
                } else if (response.status === 'not_running') {
                    // Process çalışmıyor
                    updateTransferUI(false);
                    if (transferPollingInterval) {
                        clearInterval(transferPollingInterval);
                        transferPollingInterval = null;
                    }
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Transfer status check error:', {xhr, status, error});
        }
    });
}

// Transfer işlemini durdur
function stopTransferProcess() {
    if (!confirm('Veri aktarım işlemini durdurmak istediğinizden emin misiniz?')) {
        return;
    }

    const stopBtn = $('#stopBtn');
    const originalHtml = stopBtn.html();
    stopBtn.prop('disabled', true);
    stopBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Durduruluyor...');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/stop-process',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert('warning', response.message + '\nGeçen süre: ' + response.elapsed_time + ' saniye');
                updateTransferUI(false);

                if (transferPollingInterval) {
                    clearInterval(transferPollingInterval);
                    transferPollingInterval = null;
                }
            } else {
                showAlert('danger', response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Stop process error:', {xhr, status, error});
            showAlert('danger', 'İşlem durdurulurken sunucu hatası oluştu: ' + error);
        },
        complete: function() {
            stopBtn.prop('disabled', false);
            stopBtn.html(originalHtml);
        }
    });
}

// Transfer UI durumunu güncelle
function updateTransferUI(isRunning) {
    const transferBtn = $('#transferBtn');
    const stopBtn = $('#stopBtn');
    const transferStatus = $('#transferStatus');

    if (isRunning) {
        // Aktarım çalışıyor durumu
        transferBtn.prop('disabled', true);
        transferBtn.html('<i class="fas fa-cog fa-spin me-1"></i>Aktarılıyor...');
        stopBtn.show();
        transferStatus.show();
    } else {
        // Aktarım durmuş durumu
        transferBtn.prop('disabled', false);
        transferBtn.html('<i class="fas fa-upload me-1"></i>Logo\'ya Veri Aktar');
        stopBtn.hide();
        transferStatus.hide();
        $('#transferElapsedTime').text('Geçen süre: 0 saniye');
        $('#transferExePath').text('');
    }
}

// Debug için dosya kontrol fonksiyonu
function checkBarkoFiles() {
    console.log('DEBUG - Checking PetrolLogoTumAktarimlar files...');

    $.ajax({
        url: '/petrol-barkopos-guncelleme/check-files',
        method: 'GET',
        success: function(response) {
            console.log('DEBUG - File check result:', response);
            if (response.success) {
                let message = 'Dosya Kontrol Sonuçları:\n\n';

                // Dizinler
                for (const [dir, info] of Object.entries(response.result.directories)) {
                    message += `📁 ${dir}\n`;
                    message += `   Var: ${info.exists ? 'Evet' : 'Hayır'}\n`;
                    if (info.files && info.files.length > 0) {
                        message += `   Dosyalar: ${info.files.join(', ')}\n`;
                    }
                    if (info.error) {
                        message += `   Hata: ${info.error}\n`;
                    }
                    message += '\n';
                }

                // Bulunan ilgili dosyalar
                if (response.result.found_files.length > 0) {
                    message += 'İlgili Dosyalar:\n';
                    response.result.found_files.forEach(file => {
                        message += `🔹 ${file.name}\n`;
                        message += `   Yol: ${file.path}\n`;
                        message += `   Tür: ${file.is_file ? 'Dosya' : 'Dizin'}\n\n`;
                    });
                }

                alert(message);
            } else {
                showAlert('danger', 'Dosya kontrolü sırasında hata: ' + response.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('File check error:', {xhr, status, error});
            showAlert('danger', 'Dosya kontrolü sırasında sunucu hatası: ' + error);
        }
    });
}

// Utility function for alerts
function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <div style="white-space: pre-line;">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // Remove existing alerts
    $('.alert').remove();

    // Add new alert at the top of the page
    $('.container-fluid').prepend(alertHtml);

    // Auto dismiss after 8 seconds for info/success, 10 seconds for errors
    const dismissTime = (type === 'success' || type === 'info') ? 8000 : 10000;
    setTimeout(function() {
        $('.alert').fadeOut(500, function() {
            $(this).remove();
        });
    }, dismissTime);
}

// Cleanup function - sayfa kapatılırken veya yenilenirken çalışır
$(window).on('beforeunload', function() {
    if (transferPollingInterval) {
        clearInterval(transferPollingInterval);
        transferPollingInterval = null;
    }
});

// Page visibility change event - sayfa gizlendiğinde/gösterildiğinde
$(document).on('visibilitychange', function() {
    if (document.hidden) {
        // Sayfa gizlendi, polling'i durdur
        if (transferPollingInterval) {
            clearInterval(transferPollingInterval);
            transferPollingInterval = null;
        }
    } else {
        // Sayfa gösterildi, eğer transfer durumu kontrolü gerekiyorsa başlat
        checkTransferStatus();
    }
});
</script>
{% endblock %}