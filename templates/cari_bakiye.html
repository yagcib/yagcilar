{% extends "base_layout.html" %}

{% block title %}Cari Bakiye Raporu - Yagcilar Holding{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>

<style>
    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        position: relative;
    }

    .currency-info {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 180px;
        font-size: 0.85rem;
        backdrop-filter: blur(10px);
    }

    .currency-info h6 {
        margin: 0 0 8px 0;
        font-size: 0.9rem;
        color: #555;
        font-weight: 600;
    }

    .currency-rate {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-weight: 500;
        color: #333;
    }

    .currency-rate:last-child {
        margin-bottom: 0;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .tab-content {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 500;
        padding: 12px 24px;
        margin-right: 5px;
        border-radius: 10px 10px 0 0;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .detail-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-weight: 500;
        padding: 15px 10px;
    }

    .table td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background-color: #f8f9ff;
    }

    .positive {
        color: #28a745;
        font-weight: bold;
    }

    .negative {
        color: #dc3545;
        font-weight: bold;
    }

    /* Alacak ve borç arka plan renkleri (eski borç->alacak, eski alacak->borç) */
    .table .debt-amount,
    #detailTable .debt-amount {
        background-color: #f0f4f8 !important;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .table .receivable-amount,
    #detailTable .receivable-amount {
        background-color: #fef9e7 !important;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .table .total-debt,
    #detailTable .total-debt {
        background-color: #e8f4f8 !important;
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 6px;
    }

    .table .total-receivable,
    #detailTable .total-receivable {
        background-color: #fff8e1 !important;
        font-weight: bold;
        padding: 6px 10px;
        border-radius: 6px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 10px 30px;
        font-weight: 500;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .risk-indicator {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .risk-low {
        background-color: #d4edda;
        color: #155724;
    }

    .risk-medium {
        background-color: #fff3cd;
        color: #856404;
    }

    .risk-high {
        background-color: #f8d7da;
        color: #721c24;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .autocomplete {
        position: relative;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        max-height: 200px;
        overflow-y: auto;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
        color: #333;
    }

    .autocomplete-items div:hover {
        background-color: #e9e9e9;
        color: #000;
    }

    .autocomplete-active {
        background-color: #667eea !important;
        color: #ffffff !important;
    }

    /* Multi-select dropdown stilleri */
    .multi-select {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .multi-select-button {
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        width: 100%;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .multi-select-button:hover {
        border-color: #667eea;
    }

    .multi-select-button:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: 0;
    }

    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .multi-select-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f8f9fa;
        color: #212529;
    }

    .multi-select-option:hover {
        background-color: #f8f9fa;
    }

    .multi-select-option input[type="checkbox"] {
        margin: 0;
    }

    .multi-select-option label {
        color: #212529 !important;
        font-weight: 500;
        margin: 0;
        cursor: pointer;
        flex: 1;
    }

    .multi-select-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
        font-size: 0.875rem;
    }

    .export-buttons {
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
    }

    .export-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
    }

    .export-btn:hover {
        transform: scale(1.1);
    }

    .btn-copy { background-color: #6c757d; }
    .btn-csv { background-color: #28a745; }
    .btn-excel { background-color: #007bff; }
    .btn-pdf { background-color: #dc3545; }
    .btn-print { background-color: #17a2b8; }

    /* Cari Arama ve Toplam Alanları */
    .search-summary-area {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .summary-box {
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
    }

    .summary-box.debt {
        background: #fff8dc; /* Açık tonlarda sarı - eski receivable rengi */
        border: 1px solid #f1c40f;
    }

    .summary-box.receivable {
        background: #e9ecef; /* Soft gri - eski debt rengi */
        border: 1px solid #ced4da;
    }

    .summary-box.net-positive {
        background: #d4edda; /* Soft yeşil */
        border: 1px solid #c3e6cb;
    }

    .summary-box.net-negative {
        background: #f8d7da; /* Kırmızı */
        border: 1px solid #f5c6cb;
    }

    .summary-box h6 {
        margin: 0 0 5px 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .summary-box .amount {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0;
    }

    /* Sıra numarası kolonu için stil */
    .sequence-column {
        width: 60px;
        text-align: center;
        font-weight: 600;
    }

    /* Trend analizi sekmeleri için stiller */
    .nav-pills .nav-link {
        border-radius: 25px;
        font-weight: 500;
        padding: 10px 20px;
        margin: 0 3px;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link:not(.active) {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .nav-pills .nav-link:not(.active):hover {
        background: #e9ecef;
        color: #495057;
        transform: translateY(-2px);
    }

    #receivable-trend-tab.active {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%) !important;
        color: white !important;
    }

    #net-trend-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }

    /* Trend tabloları için stiller */
    .table-sm th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 0.8rem;
        padding: 8px 5px;
    }

    .table-sm td {
        font-size: 0.8rem;
        padding: 6px 5px;
        border-bottom: 1px solid #eee;
    }

    .trend-positive {
        color: #28a745;
        font-weight: bold;
    }

    .trend-negative {
        color: #dc3545;
        font-weight: bold;
    }

    .trend-neutral {
        color: #6c757d;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filtre Alanı -->
<div class="card filter-card mb-4" style="position: relative;">
    <!-- Döviz Kurları Bilgi Kutusu - Sağ üst köşeye taşındı -->
    <div class="currency-info">
        <h6><i class="fas fa-dollar-sign"></i> Döviz Kurları</h6>
        <div style="font-size: 0.8rem; color: #666; margin-bottom: 8px;">{{ selected_date }}</div>
        <div class="currency-rate">
            <span>USD:</span>
            <span id="usd-rate">{{ "{:,.4f}".format(usd_kuru).replace(".", ",") }} ₺</span>
        </div>
        <div class="currency-rate">
            <span>EUR:</span>
            <span id="eur-rate">{{ "{:,.4f}".format(eur_kuru).replace(".", ",") }} ₺</span>
        </div>
    </div>

    <div class="card-body">
        <h5 class="card-title mb-4">
            <i class="fas fa-filter"></i> Rapor Filtreleri
        </h5>
        <form id="filterForm" method="GET">
            <div class="row">
                <div class="col-md-2">
                    <label for="date" class="form-label">Tarih</label>
                    <input type="date" class="form-control" id="date" name="date"
                           value="{{ selected_date }}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Firma</label>
                    <div class="multi-select" id="firma-select">
                        <button type="button" class="multi-select-button">
                            <span class="multi-select-text">Tüm Firmalar</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown">
                            {% for firma in firma_list %}
                            <div class="multi-select-option">
                                <input type="checkbox" id="firma-{{ loop.index }}" value="{{ firma }}" checked>
                                <label for="firma-{{ loop.index }}">{{ firma }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cari Grup</label>
                    <div class="multi-select" id="cari-grup-select">
                        <button type="button" class="multi-select-button">
                            <span class="multi-select-text">Tüm Gruplar</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-option">
                                <input type="checkbox" id="cari-grup-bos" value="" checked>
                                <label for="cari-grup-bos">(Boş)</label>
                            </div>
                            {% for grup in cari_grup_list %}
                            <div class="multi-select-option">
                                <input type="checkbox" id="cari-grup-{{ loop.index }}" value="{{ grup }}" checked>
                                <label for="cari-grup-{{ loop.index }}">{{ grup }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cari Türü</label>
                    <div class="multi-select" id="cari-tur-select">
                        <button type="button" class="multi-select-button">
                            <span class="multi-select-text">Tüm Türler</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-option">
                                <input type="checkbox" id="cari-tur-bos" value="" checked>
                                <label for="cari-tur-bos">(Boş)</label>
                            </div>
                            {% for tur in cari_tur_list %}
                            <div class="multi-select-option">
                                <input type="checkbox" id="cari-tur-{{ loop.index }}" value="{{ tur }}" checked>
                                <label for="cari-tur-{{ loop.index }}">{{ tur }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="cari" class="form-label">Cari Arama</label>
                    <div class="autocomplete">
                        <input type="text" class="form-control" id="cari" name="cari"
                               value="{{ selected_cari }}" placeholder="Cari adı ile arayın...">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Durum</label>
                    <div class="multi-select" id="durum-select">
                        <button type="button" class="multi-select-button">
                            <span class="multi-select-text">Tümü</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-option">
                                <input type="checkbox" id="durum-borclu" value="borclu" checked>
                                <label for="durum-borclu">Borçlu</label>
                            </div>
                            <div class="multi-select-option">
                                <input type="checkbox" id="durum-alacakli" value="alacakli" checked>
                                <label for="durum-alacakli">Alacaklı</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="button" class="btn btn-secondary" id="clearFilters">
                        <i class="fas fa-eraser"></i> Temizle
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Getir
                    </button>
                </div>
            </div>

            <!-- Hidden inputs for form submission -->
            <input type="hidden" id="selected-firmas" name="firmas" value="">
            <input type="hidden" id="selected-cari-grups" name="cari_grups" value="">
            <input type="hidden" id="selected-cari-turs" name="cari_turs" value="">
            <input type="hidden" id="selected-durums" name="durums" value="">
        </form>

        <!-- Export Buttons -->
        <div class="export-buttons">
            <button class="export-btn btn-copy" title="Kopyala" onclick="exportData('copy')">
                <i class="fas fa-copy"></i>
            </button>
            <button class="export-btn btn-csv" title="CSV" onclick="exportData('csv')">
                <i class="fas fa-file-csv"></i>
            </button>
            <button class="export-btn btn-excel" title="Excel" onclick="exportData('excel')">
                <i class="fas fa-file-excel"></i>
            </button>
            <button class="export-btn btn-pdf" title="PDF" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button class="export-btn btn-print" title="Yazdır" onclick="exportData('print')">
                <i class="fas fa-print"></i>
            </button>
        </div>
    </div>
</div>

<!-- Sekme Yapısı -->
<ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="genel-tab" data-bs-toggle="tab"
                data-bs-target="#genel" type="button" role="tab">
            <i class="fas fa-chart-pie"></i> Genel Durum
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="detay-tab" data-bs-toggle="tab"
                data-bs-target="#detay" type="button" role="tab">
            <i class="fas fa-table"></i> Cari Detaylı Bakiye
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="kur-tab" data-bs-toggle="tab"
                data-bs-target="#kur" type="button" role="tab">
            <i class="fas fa-chart-line"></i> Kur Analizi
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="karsilastirma-tab" data-bs-toggle="tab"
                data-bs-target="#karsilastirma" type="button" role="tab">
            <i class="fas fa-balance-scale"></i> Firma Karşılaştırma
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="risk-tab" data-bs-toggle="tab"
                data-bs-target="#risk" type="button" role="tab">
            <i class="fas fa-exclamation-triangle"></i> Risk Analizi
        </button>
    </li>
</ul>

<!-- Sekme İçerikleri -->
<div class="tab-content" id="reportTabContent">
    <!-- Genel Durum Sekmesi -->
    <div class="tab-pane fade show active" id="genel" role="tabpanel">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-card text-center">
                    <div class="summary-value" id="total-debt">
                        {{ "{:,.2f}".format(results|sum(attribute='TOPLAM_TL_ALACAK')).replace(".", ",") }} ₺
                    </div>
                    <div class="summary-label">Toplam Alacak</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card text-center">
                    <div class="summary-value" id="total-receivable">
                        {{ "{:,.2f}".format(results|sum(attribute='TOPLAM_TL_BORC')).replace(".", ",") }} ₺
                    </div>
                    <div class="summary-label">Toplam Borç</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card text-center">
                    <div class="summary-value" id="net-position">
                        {% set net = results|sum(attribute='TOPLAM_TL_ALACAK') - results|sum(attribute='TOPLAM_TL_BORC') %}
                        {{ "{:,.2f}".format(net).replace(".", ",") }} ₺
                    </div>
                    <div class="summary-label">Net Pozisyon</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card text-center">
                    <div class="summary-value" id="total-cari">
                        {{ results|length }}
                    </div>
                    <div class="summary-label">Toplam Cari</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Firmalar Bazında Alacak Dağılımı</h6>
                    <canvas id="debtChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Döviz Türlerine Göre Dağılım</h6>
                    <canvas id="currencyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Alacak-Borç Karşılaştırması</h6>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Cari Detaylı Bakiye Sekmesi - Güncellenmiş Sayı Formatları -->
<div class="tab-pane fade" id="detay" role="tabpanel">
    <!-- Cari Arama ve Toplam Alanları -->
    <div class="search-summary-area">
        <div class="row">
            <div class="col-md-4">
                <label for="detail-search" class="form-label"><strong>Cari Detay Arama</strong></label>
                <input type="text" class="form-control" id="detail-search" placeholder="Tabloda arama yapın...">
                <small class="text-muted">Net Durum ≠ 0 olan {{ results|length }} cari hesap listelendi</small>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-4">
                        <div class="summary-box receivable">
                            <h6>Cari Alacak TL Karşılığı</h6>
                            <p class="amount">{{ "{:,.2f}".format(results|sum(attribute='TOPLAM_TL_ALACAK')).replace(",", "X").replace(".", ",").replace("X", ".") }} ₺</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-box debt">
                            <h6>Cari Borç TL Karşılığı</h6>
                            <p class="amount">{{ "{:,.2f}".format(results|sum(attribute='TOPLAM_TL_BORC')).replace(",", "X").replace(".", ",").replace("X", ".") }} ₺</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        {% set net = results|sum(attribute='TOPLAM_TL_ALACAK') - results|sum(attribute='TOPLAM_TL_BORC') %}
                        <div class="summary-box {% if net > 0 %}net-positive{% else %}net-negative{% endif %}">
                            <h6>Net Durum</h6>
                            <p class="amount">{{ "{:,.2f}".format(net).replace(",", "X").replace(".", ",").replace("X", ".") }} ₺</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive detail-table">
        <table class="table table-hover" id="detailTable">
            <thead>
                <tr>
                    <th class="sequence-column">Sıra No</th>
                    <th>Firma</th>
                    <th>VKN/TCKNO</th>
                    <th>Cari Ünvanı</th>
                    <th>USD Alacak</th>
                    <th>EUR Alacak</th>
                    <th>TL Alacak</th>
                    <th>Toplam Alacak TL Karşılığı</th>
                    <th>USD Borç</th>
                    <th>EUR Borç</th>
                    <th>TL Borç</th>
                    <th>Toplam Borç TL Karşılığı</th>
                    <th>Net Durum</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                {% set net = row.TOPLAM_TL_ALACAK - row.TOPLAM_TL_BORC %}
                {% if net != 0 %}
                <tr>
                    <td class="text-center sequence-column"></td>
                    <td><strong>{{ row.FIRMA }}</strong></td>
                    <td>{{ row['VKN&TCKNO'] }}</td>
                    <td>{{ row.CARI_UNVANI }}</td>
                    <td class="text-end receivable-amount" data-export="{{ row.USD_ALACAK }}">{{ "{:,.2f}".format(row.USD_ALACAK).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end receivable-amount" data-export="{{ row.EURO_ALACAK }}">{{ "{:,.2f}".format(row.EURO_ALACAK).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end receivable-amount" data-export="{{ row.TL_ALACAK }}">{{ "{:,.2f}".format(row.TL_ALACAK).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end total-receivable" data-export="{{ row.TOPLAM_TL_ALACAK }}">{{ "{:,.2f}".format(row.TOPLAM_TL_ALACAK).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end debt-amount" data-export="{{ row.USD_BORC }}">{{ "{:,.2f}".format(row.USD_BORC).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end debt-amount" data-export="{{ row.EURO_BORC }}">{{ "{:,.2f}".format(row.EURO_BORC).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end debt-amount" data-export="{{ row.TL_BORC }}">{{ "{:,.2f}".format(row.TL_BORC).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end total-debt" data-export="{{ row.TOPLAM_TL_BORC }}">{{ "{:,.2f}".format(row.TOPLAM_TL_BORC).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td class="text-end" data-sort="{{ "%.2f"|format(net) }}" data-export="{{ "%.2f"|format(net) }}">
                        {% if net > 0 %}
                            <!-- Alacaklı ise negatif göster ve kırmızı yap -->
                            <span class="negative">
                                -{{ "{:,.2f}".format(net).replace(",", "X").replace(".", ",").replace("X", ".") }}
                            </span>
                        {% elif net < 0 %}
                            <!-- Borçlu ise pozitif göster ve yeşil yap -->
                            <span class="positive">
                                {{ "{:,.2f}".format(net|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                            </span>
                        {% else %}
                            <span style="color: #6c757d;">
                                {{ "{:,.2f}".format(net).replace(",", "X").replace(".", ",").replace("X", ".") }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if net > 0 %}
                            <!-- Alacaklı ise kırmızı -->
                            <span class="badge" style="background-color: #dc3545; color: white;">Alacaklı</span>
                        {% elif net < 0 %}
                            <!-- Borçlu ise yeşil -->
                            <span class="badge" style="background-color: #28a745; color: white;">Borçlu</span>
                        {% else %}
                            <span class="badge bg-secondary">Sıfır</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


    <!-- Kur Analizi Sekmesi -->
    <div class="tab-pane fade" id="kur" role="tabpanel">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Döviz Pozisyon Analizi</h6>
                    <canvas id="currencyPositionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Kur Riski Değerlendirmesi</h6>
                    <canvas id="currencyRiskChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Döviz Kur Bilgileri</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>USD Satış Kuru:</strong> {{ "{:,.4f}".format(usd_kuru).replace(".", ",") }} ₺</p>
                                <p><strong>EUR Satış Kuru:</strong> {{ "{:,.4f}".format(eur_kuru).replace(".", ",") }} ₺</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Toplam USD Pozisyon:</strong>
                                    {% set usd_net = results|sum(attribute='USD_BORC') - results|sum(attribute='USD_ALACAK') %}
                                    <span class="{% if usd_net >= 0 %}positive{% else %}negative{% endif %}">
                                        {{ "{:,.2f}".format(usd_net).replace(".", ",") }} USD
                                    </span>
                                </p>
                                <p><strong>Toplam EUR Pozisyon:</strong>
                                    {% set eur_net = results|sum(attribute='EURO_BORC') - results|sum(attribute='EURO_ALACAK') %}
                                    <span class="{% if eur_net >= 0 %}positive{% else %}negative{% endif %}">
                                        {{ "{:,.2f}".format(eur_net).replace(".", ",") }} EUR
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firma Karşılaştırma Sekmesi -->
    <div class="tab-pane fade" id="karsilastirma" role="tabpanel">
        <div class="chart-container">
            <h6 class="text-center mb-3">Firma Bazında Toplam Pozisyon Karşılaştırması</h6>
            <canvas id="firmaComparisonChart"></canvas>
        </div>

        <div class="row">
            {% for firma in firma_list %}
            {% set firma_data = results|selectattr("FIRMA", "equalto", firma)|list %}
            {% if firma_data %}
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="card-title">{{ firma }}</h6>
                        <p class="card-text">
                            <strong>Toplam Alacak:</strong><br>
                            <span class="positive">{{ "{:,.2f}".format(firma_data|sum(attribute='TOPLAM_TL_ALACAK')).replace(".", ",") }} ₺</span>
                        </p>
                        <p class="card-text">
                            <strong>Toplam Borç:</strong><br>
                            <span class="negative">{{ "{:,.2f}".format(firma_data|sum(attribute='TOPLAM_TL_BORC')).replace(".", ",") }} ₺</span>
                        </p>
                        <p class="card-text">
                            <strong>Net Pozisyon:</strong><br>
                            {% set net = firma_data|sum(attribute='TOPLAM_TL_ALACAK') - firma_data|sum(attribute='TOPLAM_TL_BORC') %}
                            <span class="{% if net >= 0 %}positive{% else %}negative{% endif %}">
                                {{ "{:,.2f}".format(net).replace(".", ",") }} ₺
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Risk Analizi Sekmesi -->
    <div class="tab-pane fade" id="risk" role="tabpanel">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Risk Analizi Açıklaması</h6>
                    <p class="mb-0">Bu analiz, döviz pozisyonları ve cari bakiye dağılımları temelinde risk değerlendirmesi yapmaktadır.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Döviz Risk Dağılımı</h6>
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6 class="text-center mb-3">Cari Risk Analizi</h6>
                    <canvas id="cariRiskChart"></canvas>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Cari Ünvanı</th>
                        <th>Firma</th>
                        <th>Toplam Pozisyon</th>
                        <th>Döviz Riski</th>
                        <th>Risk Seviyesi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    {% if row.CARI_UNVANI %}
                    <tr>
                        <td>{{ row.CARI_UNVANI }}</td>
                        <td>{{ row.FIRMA }}</td>
                        <td class="text-end">
                            {% set net = row.TOPLAM_TL_ALACAK - row.TOPLAM_TL_BORC %}
                            <span class="{% if net >= 0 %}positive{% else %}negative{% endif %}">
                                {{ "{:,.2f}".format(net).replace(".", ",") }} ₺
                            </span>
                        </td>
                        <td class="text-end">
                            {% set fx_exposure = (row.USD_ALACAK + row.USD_BORC) * row.USD_SATIS_KURU + (row.EURO_ALACAK + row.EURO_BORC) * row.EUR_SATIS_KURU %}
                            {{ "{:,.2f}".format(fx_exposure).replace(".", ",") }} ₺
                        </td>
                        <td>
                            {% set total_exposure = row.TOPLAM_TL_ALACAK + row.TOPLAM_TL_BORC %}
                            {% if total_exposure < 100000 %}
                                <span class="risk-indicator risk-low">Düşük</span>
                            {% elif total_exposure < 500000 %}
                                <span class="risk-indicator risk-medium">Orta</span>
                            {% else %}
                                <span class="risk-indicator risk-high">Yüksek</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yükleniyor...</span>
    </div>
    <p class="mt-2">Veriler yükleniyor...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global değişkenler
let table;
let results = {{ results|tojson }};

// Türkçe sayı formatı fonksiyonu - Güncellenmiş
function formatMoney(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '0,00';
    }

    // Türkçe format: binlik ayracı nokta (.), ondalık ayracı virgül (,)
    return new Intl.NumberFormat('tr-TR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

// Sayıyı Türkçe formatına çeviren yardımcı fonksiyon
function formatNumberTurkish(num) {
    if (num === null || num === undefined || isNaN(num)) {
        return '0,00';
    }

    const parts = Math.abs(num).toFixed(2).split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];

    // Binlik ayracı ekle (nokta)
    const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    // Sonucu birleştir (ondalık ayracı virgül)
    return (num < 0 ? '-' : '') + formattedInteger + ',' + decimalPart;
}

// DataTable sütun formatları için özel render fonksiyonları
$.fn.dataTable.render.turkishNumber = function() {
    return function(data, type, row) {
        if (type === 'display' || type === 'type') {
            return formatNumberTurkish(parseFloat(data) || 0);
        }
        return data;
    };
};



// DataTable konfigürasyonuna sütun formatları ekle
$(document).ready(function() {
    // Mevcut DataTable yapılandırmasına columnDefs ekle
    if (table) {
        table.destroy(); // Mevcut tabloyu yok et
    }

    table = $('#detailTable').DataTable({
        responsive: true,
        pageLength: 250,
        order: [[12, 'desc']],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json'
        },
        dom: 'Brtip',
        columnDefs: [
            {
                targets: 0, // Sıra numarası kolonu
                orderable: false,
                searchable: false
            },
            {
                targets: [4, 5, 6, 7, 8, 9, 10, 11, 12], // Sayısal kolonlar
                className: 'text-end'
            }
        ],
        buttons: [
            {
                extend: 'copy',
                className: 'buttons-copy d-none',
                exportOptions: {
                    format: {
                        body: function (data, row, column, node) {
                            if (column === 0) {
                                return $(node).text();
                            }
                            if ($(node).attr('data-export')) {
                                return $(node).attr('data-export');
                            }
                            return $(node).text();
                        }
                    }
                }
            },
            {
                extend: 'csv',
                className: 'buttons-csv d-none',
                exportOptions: {
                    format: {
                        body: function (data, row, column, node) {
                            if (column === 0) {
                                return $(node).text();
                            }
                            if ($(node).attr('data-export')) {
                                return $(node).attr('data-export');
                            }
                            return $(node).text();
                        }
                    }
                }
            },
            {
                extend: 'excel',
                className: 'buttons-excel d-none',
                title: '',
                exportOptions: {
                    format: {
                        body: function (data, row, column, node) {
                            if (column === 0) {
                                return $(node).text();
                            }
                            if ($(node).attr('data-export')) {
                                return $(node).attr('data-export');
                            }
                            return $(node).text();
                        }
                    }
                }
            },
            {
                extend: 'pdf',
                className: 'buttons-pdf d-none',
                title: '',
                exportOptions: {
                    format: {
                        body: function (data, row, column, node) {
                            if (column === 0) {
                                return $(node).text();
                            }
                            if ($(node).attr('data-export')) {
                                return $(node).attr('data-export');
                            }
                            return $(node).text();
                        }
                    }
                }
            },
            {
                extend: 'print',
                className: 'buttons-print d-none',
                title: '',
                exportOptions: {
                    format: {
                        body: function (data, row, column, node) {
                            if (column === 0) {
                                return $(node).text();
                            }
                            if ($(node).attr('data-export')) {
                                return $(node).attr('data-export');
                            }
                            return $(node).text();
                        }
                    }
                }
            }
        ]
    });

    // Sıra numarasını dinamik olarak güncelle
    table.on('draw.dt', function() {
        updateSequenceNumbers();
    });

    // İlk yüklemede sıra numarasını ayarla
    updateSequenceNumbers();

    // Cari detay arama fonksiyonu
    $('#detail-search').on('keyup', function() {
        table.search(this.value).draw();
    });

    // Export functions
    window.exportData = function(type) {
        switch(type) {
            case 'copy':
                table.button('.buttons-copy').trigger();
                break;
            case 'csv':
                table.button('.buttons-csv').trigger();
                break;
            case 'excel':
                table.button('.buttons-excel').trigger();
                break;
            case 'pdf':
                table.button('.buttons-pdf').trigger();
                break;
            case 'print':
                table.button('.buttons-print').trigger();
                break;
        }
    }

    // Multi-select ve diğer fonksiyonları başlat
    initMultiSelect();
    initAutocomplete();
    restoreSelectedValues();
    initCharts();

    // Clear filters
    $('#clearFilters').on('click', function() {
        $('#firma-select input[type="checkbox"]').prop('checked', true);
        $('#cari-tur-select input[type="checkbox"]').prop('checked', true);
        $('#durum-select input[type="checkbox"]').prop('checked', true);
        $('#cari-grup-select input[type="checkbox"]').prop('checked', true);
        $('#cari').val('');

        $('.multi-select').each(function() {
            updateMultiSelectText(this);
        });

        $('.multi-select-dropdown').hide();
    });

    // Form submission
    $('#filterForm').on('submit', function(e) {
        const selectedFirmas = [];
        $('#firma-select input[type="checkbox"]:checked').each(function() {
            selectedFirmas.push($(this).val());
        });

        const selectedCariGrups = [];
        $('#cari-grup-select input[type="checkbox"]:checked').each(function() {
            selectedCariGrups.push($(this).val());
        });

        const selectedCariTurs = [];
        $('#cari-tur-select input[type="checkbox"]:checked').each(function() {
            selectedCariTurs.push($(this).val());
        });

        const selectedDurums = [];
        $('#durum-select input[type="checkbox"]:checked').each(function() {
            selectedDurums.push($(this).val());
        });

        $('#selected-firmas').val(selectedFirmas.join(','));
        $('#selected-cari-grups').val(selectedCariGrups.join(','));
        $('#selected-cari-turs').val(selectedCariTurs.join(','));
        $('#selected-durums').val(selectedDurums.join(','));

        showLoading();
    });
});

function initMultiSelect() {
    $('.multi-select').each(function() {
        const multiSelect = this;
        const button = $(this).find('.multi-select-button');
        const dropdown = $(this).find('.multi-select-dropdown');

        button.off('click').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $('.multi-select-dropdown').not(dropdown).hide();
            dropdown.toggle();
        });

        $(this).find('input[type="checkbox"]').off('change').on('change', function() {
            updateMultiSelectText(multiSelect);
        });

        updateMultiSelectText(multiSelect);
    });

    $(document).off('click.multiselect').on('click.multiselect', function(e) {
        if (!$(e.target).closest('.multi-select').length) {
            $('.multi-select-dropdown').hide();
        }
    });
}

function updateMultiSelectText(multiSelectElement) {
    const textElement = $(multiSelectElement).find('.multi-select-text');
    const checkboxes = $(multiSelectElement).find('input[type="checkbox"]:checked');
    const selectId = $(multiSelectElement).attr('id');
    const totalCheckboxes = $(multiSelectElement).find('input[type="checkbox"]').length;

    if (checkboxes.length === 0) {
        if (selectId === 'firma-select') {
            textElement.text('Hiç Firma Seçilmedi');
        } else if (selectId === 'cari-grup-select') {
            textElement.text('Hiç Grup Seçilmedi');
        } else if (selectId === 'cari-tur-select') {
            textElement.text('Hiç Tür Seçilmedi');
        } else if (selectId === 'durum-select') {
            textElement.text('Hiç Durum Seçilmedi');
        }
    } else if (checkboxes.length === totalCheckboxes) {
        if (selectId === 'firma-select') {
            textElement.text('Tüm Firmalar');
        } else if (selectId === 'cari-grup-select') {
            textElement.text('Tüm Gruplar');
        } else if (selectId === 'cari-tur-select') {
            textElement.text('Tüm Türler');
        } else if (selectId === 'durum-select') {
            textElement.text('Tümü');
        }
    } else if (checkboxes.length === 1) {
        const selectedLabel = checkboxes.first().next('label').text();
        textElement.text(selectedLabel);
    } else {
        textElement.text(`${checkboxes.length} Seçili`);
    }
}

function restoreSelectedValues() {
    const selectedFirmasRaw = '{{ selected_firmas }}';
    const selectedCariGrupsRaw = '{{ selected_cari_grups }}';
    const selectedCariTursRaw = '{{ selected_cari_turs }}';
    const selectedDurumsRaw = '{{ selected_durums }}';

    if (!selectedFirmasRaw && !selectedCariGrupsRaw && !selectedCariTursRaw && !selectedDurumsRaw) {
        $('#cari-grup-select input[type="checkbox"]').prop('checked', true);
        updateMultiSelectText(document.getElementById('cari-grup-select'));
        return;
    }

    if (selectedFirmasRaw) {
        const selectedFirmas = selectedFirmasRaw.split(',').map(f => f.trim()).filter(f => f);
        $('#firma-select input[type="checkbox"]').prop('checked', false);
        selectedFirmas.forEach(firma => {
            $('#firma-select input[value="' + firma + '"]').prop('checked', true);
        });
        updateMultiSelectText(document.getElementById('firma-select'));
    }

    if (selectedCariGrupsRaw) {
        const selectedCariGrups = selectedCariGrupsRaw.split(',').map(g => g.trim());
        $('#cari-grup-select input[type="checkbox"]').prop('checked', false);
        selectedCariGrups.forEach(grup => {
            if (grup === '') {
                $('#cari-grup-select input[value=""]').prop('checked', true);
            } else if (grup) {
                $('#cari-grup-select input[value="' + grup + '"]').prop('checked', true);
            }
        });
        updateMultiSelectText(document.getElementById('cari-grup-select'));
    }

    if (selectedCariTursRaw) {
        const selectedCariTurs = selectedCariTursRaw.split(',').map(t => t.trim());
        $('#cari-tur-select input[type="checkbox"]').prop('checked', false);
        selectedCariTurs.forEach(tur => {
            if (tur === '') {
                $('#cari-tur-select input[value=""]').prop('checked', true);
            } else if (tur) {
                $('#cari-tur-select input[value="' + tur + '"]').prop('checked', true);
            }
        });
        updateMultiSelectText(document.getElementById('cari-tur-select'));
    }

    if (selectedDurumsRaw) {
        const selectedDurums = selectedDurumsRaw.split(',').map(d => d.trim()).filter(d => d);
        $('#durum-select input[type="checkbox"]').prop('checked', false);
        selectedDurums.forEach(durum => {
            $('#durum-select input[value="' + durum + '"]').prop('checked', true);
        });
        updateMultiSelectText(document.getElementById('durum-select'));
    }
}

function initAutocomplete() {
    const cariInput = document.getElementById('cari');
    if (!cariInput) return;

    let cariList = [];
    try {
        const cariListRaw = '{{ cari_list|tojson|safe }}';
        if (cariListRaw && cariListRaw !== '[]' && cariListRaw !== 'null') {
            cariList = JSON.parse(cariListRaw);
        }
    } catch (e) {
        console.log('Cari list parse hatası:', e);
        cariList = [];
    }

    if (cariList.length === 0) return;

    cariInput.addEventListener('input', function() {
        closeAllLists();
        const val = this.value.trim();
        if (!val || val.length < 2) return false;

        const autocompleteList = document.createElement('div');
        autocompleteList.setAttribute('id', this.id + '-autocomplete-list');
        autocompleteList.setAttribute('class', 'autocomplete-items');
        this.parentNode.appendChild(autocompleteList);

        let matchCount = 0;
        const searchTerm = val.toLowerCase();

        for (let i = 0; i < cariList.length; i++) {
            if (matchCount >= 10) break;

            const cariName = String(cariList[i]).toLowerCase();
            if (cariName.includes(searchTerm)) {
                const item = document.createElement('div');
                const matchIndex = cariName.indexOf(searchTerm);
                const originalText = String(cariList[i]);

                item.innerHTML = originalText.substr(0, matchIndex);
                item.innerHTML += '<strong>' + originalText.substr(matchIndex, val.length) + '</strong>';
                item.innerHTML += originalText.substr(matchIndex + val.length);

                item.addEventListener('click', function() {
                    cariInput.value = originalText;
                    closeAllLists();
                });

                autocompleteList.appendChild(item);
                matchCount++;
            }
        }

        if (matchCount === 0) {
            const item = document.createElement('div');
            item.innerHTML = '<em>Sonuç bulunamadı...</em>';
            item.style.fontStyle = 'italic';
            item.style.color = '#666';
            autocompleteList.appendChild(item);
        }
    });

    function closeAllLists(except) {
        const autocompleteItems = document.getElementsByClassName('autocomplete-items');
        for (let i = 0; i < autocompleteItems.length; i++) {
            if (except != autocompleteItems[i] && except != cariInput) {
                autocompleteItems[i].parentNode.removeChild(autocompleteItems[i]);
            }
        }
    }

    document.addEventListener('click', function(e) {
        closeAllLists(e.target);
    });
}

function initCharts() {
    console.log('Charts başlatılıyor, results:', results);

    if (!results || results.length === 0) {
        console.log('Results boş, grafikler oluşturulamıyor');
        return;
    }

    // Firma bazında alacak dağılımı (eski borç grafiği)
    const firmaReceivables = {};
    results.forEach(row => {
        if (!firmaReceivables[row.FIRMA]) {
            firmaReceivables[row.FIRMA] = 0;
        }
        firmaReceivables[row.FIRMA] += row.TOPLAM_TL_ALACAK;
    });

    console.log('Firma alacakları:', firmaReceivables);

    // Alacak grafiği (eski borç grafiği)
    const debtChartElement = document.getElementById('debtChart');
    if (debtChartElement) {
        new Chart(debtChartElement, {
            type: 'doughnut',
            data: {
                labels: Object.keys(firmaReceivables),
                datasets: [{
                    data: Object.values(firmaReceivables),
                    backgroundColor: [
                        '#667eea',
                        '#764ba2',
                        '#f093fb'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Döviz türlerine göre dağılım
    let totalUSD = 0, totalEUR = 0, totalTL = 0;
    results.forEach(row => {
        totalUSD += (row.USD_ALACAK + row.USD_BORC) * row.USD_SATIS_KURU;
        totalEUR += (row.EURO_ALACAK + row.EURO_BORC) * row.EUR_SATIS_KURU;
        totalTL += row.TL_ALACAK + row.TL_BORC;
    });

    const currencyChartElement = document.getElementById('currencyChart');
    if (currencyChartElement) {
        new Chart(currencyChartElement, {
            type: 'pie',
            data: {
                labels: ['USD (TL Karşılığı)', 'EUR (TL Karşılığı)', 'TL'],
                datasets: [{
                    data: [totalUSD, totalEUR, totalTL],
                    backgroundColor: ['#4CAF50', '#2196F3', '#FF9800'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Alacak-Borç karşılaştırması (eski borç-alacak)
    const firmaDebts = {};
    results.forEach(row => {
        if (!firmaDebts[row.FIRMA]) {
            firmaDebts[row.FIRMA] = 0;
        }
        firmaDebts[row.FIRMA] += row.TOPLAM_TL_BORC;
    });

    const comparisonChartElement = document.getElementById('comparisonChart');
    if (comparisonChartElement) {
        new Chart(comparisonChartElement, {
            type: 'bar',
            data: {
                labels: Object.keys(firmaReceivables),
                datasets: [{
                    label: 'Alacak',
                    data: Object.values(firmaReceivables),
                    backgroundColor: '#4ecdc4',
                    borderRadius: 5
                }, {
                    label: 'Borç',
                    data: Object.values(firmaDebts),
                    backgroundColor: '#ff6b6b',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Döviz pozisyon analizi (başlıklar değiştirildi)
    let usdPosition = 0, eurPosition = 0;
    results.forEach(row => {
        usdPosition += (row.USD_BORC - row.USD_ALACAK);
        eurPosition += (row.EURO_BORC - row.EURO_ALACAK);
    });

    const currencyPositionChartElement = document.getElementById('currencyPositionChart');
    if (currencyPositionChartElement) {
        new Chart(currencyPositionChartElement, {
            type: 'bar',
            data: {
                labels: ['USD Pozisyon', 'EUR Pozisyon'],
                datasets: [{
                    data: [usdPosition, eurPosition],
                    backgroundColor: [
                        usdPosition >= 0 ? '#4CAF50' : '#f44336',
                        eurPosition >= 0 ? '#4CAF50' : '#f44336'
                    ],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatMoney(context.raw) + (context.dataIndex === 0 ? ' USD' : ' EUR');
                            }
                        }
                    }
                }
            }
        });
    }

    // Kur riski değerlendirmesi
    const currencyRiskChartElement = document.getElementById('currencyRiskChart');
    if (currencyRiskChartElement) {
        new Chart(currencyRiskChartElement, {
            type: 'radar',
            data: {
                labels: ['USD Riski', 'EUR Riski', 'TL Yoğunluğu', 'Diversifikasyon', 'Likidite'],
                datasets: [{
                    label: 'Risk Seviyesi',
                    data: [
                        Math.min(Math.abs(usdPosition) / 100000 * 100, 100),
                        Math.min(Math.abs(eurPosition) / 100000 * 100, 100),
                        Math.min(totalTL / (totalUSD + totalEUR + totalTL) * 100, 100),
                        Math.min(Object.keys(firmaReceivables).length * 20, 100),
                        80
                    ],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    pointBackgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Firma karşılaştırma grafiği
    const firmaComparisonChartElement = document.getElementById('firmaComparisonChart');
    if (firmaComparisonChartElement) {
        new Chart(firmaComparisonChartElement, {
            type: 'line',
            data: {
                labels: Object.keys(firmaReceivables),
                datasets: [{
                    label: 'Net Pozisyon',
                    data: Object.keys(firmaReceivables).map(firma => firmaReceivables[firma] - firmaDebts[firma]),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Net Pozisyon: ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Risk dağılım grafiği
    const riskLevels = { 'Düşük': 0, 'Orta': 0, 'Yüksek': 0 };
    results.forEach(row => {
        const totalExposure = row.TOPLAM_TL_ALACAK + row.TOPLAM_TL_BORC;
        if (totalExposure < 100000) {
            riskLevels['Düşük']++;
        } else if (totalExposure < 500000) {
            riskLevels['Orta']++;
        } else {
            riskLevels['Yüksek']++;
        }
    });

    const riskDistributionChartElement = document.getElementById('riskDistributionChart');
    if (riskDistributionChartElement) {
        new Chart(riskDistributionChartElement, {
            type: 'doughnut',
            data: {
                labels: Object.keys(riskLevels),
                datasets: [{
                    data: Object.values(riskLevels),
                    backgroundColor: ['#4CAF50', '#FF9800', '#f44336'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Cari risk analizi
    const cariRiskChartElement = document.getElementById('cariRiskChart');
    if (cariRiskChartElement) {
        new Chart(cariRiskChartElement, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Cari Risk',
                    data: results.map(row => ({
                        x: row.TOPLAM_TL_ALACAK + row.TOPLAM_TL_BORC,
                        y: Math.abs(row.TOPLAM_TL_ALACAK - row.TOPLAM_TL_BORC)
                    })),
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Toplam Pozisyon (TL)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Risk Miktarı (TL)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Pozisyon: ' + formatMoney(context.raw.x) + ' ₺, Risk: ' + formatMoney(context.raw.y) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    console.log('Tüm grafikler oluşturuldu');

    // Trend analizi grafiklerini başlat
    initTrendAnalysis();
}

function showLoading() {
    $('.loading-spinner').show();
    $('#reportTabContent').hide();
}

function hideLoading() {
    $('.loading-spinner').hide();
    $('#reportTabContent').show();
}

// Sıra numarasını dinamik olarak güncelleme fonksiyonu
function updateSequenceNumbers() {
    if (!table) return;

    // Görünür satırları al (sayfalama ve filtreleme dikkate alınarak)
    const visibleRows = table.rows({ page: 'current', search: 'applied' }).nodes();

    // Her satıra sıra numarası ekle
    $(visibleRows).each(function(index) {
        $(this).find('td:first-child').text(index + 1);
    });
}

// Trend analizi başlatma fonksiyonu
function initTrendAnalysis() {
    console.log('Trend analizi başlatılıyor...');

    // Mevcut verilerden aylık trend verisi oluştur
    const trendData = generateMonthlyTrendData();

    // Grafikleri oluştur
    createTrendCharts(trendData);

    // Tabloları doldur
    populateTrendTables(trendData);

    console.log('Trend analizi tamamlandı');
}

// Aylık trend verisi oluşturma fonksiyonu
function generateMonthlyTrendData() {
    if (!results || results.length === 0) return [];

    // 2025 yılı için aylık dönemler
    const periods = [
        { name: 'Ocak 2025', startDate: '2025-01-01', endDate: '2025-01-31' },
        { name: 'Şubat 2025', startDate: '2025-02-01', endDate: '2025-02-28' },
        { name: 'Mart 2025', startDate: '2025-03-01', endDate: '2025-03-31' },
        { name: 'Nisan 2025', startDate: '2025-04-01', endDate: '2025-04-30' },
        { name: 'Mayıs 2025', startDate: '2025-05-01', endDate: '2025-05-31' },
        { name: 'Haziran 2025', startDate: '2025-06-01', endDate: '2025-06-30' }
    ];

    // NOT: Gerçek implementasyon için backend API'den veri çekilmeli
    // Her dönem için ay başı ve ay sonu verileri simüle edilmiş
    const monthlyTrendData = [];

    periods.forEach((period, index) => {
        // Simüle edilmiş ay başı kur değerleri
        const startUsdRate = 34.5 + (Math.random() * 2); // 34.5-36.5 arası
        const startEurRate = 36.8 + (Math.random() * 2); // 36.8-38.8 arası

        // Simüle edilmiş ay sonu kur değerleri (genelde biraz farklı)
        const endUsdRate = startUsdRate + (Math.random() * 1.5 - 0.75); // ±0.75 değişim
        const endEurRate = startEurRate + (Math.random() * 1.5 - 0.75);

        // Mevcut verileri temel alarak ay başı/sonu hesaplaması
        // Gerçekte her tarih için backend'den çekilmeli
        let startTotalDebt = 0, startTotalReceivable = 0;
        let endTotalDebt = 0, endTotalReceivable = 0;

        results.forEach(row => {
            // Ay başı değerleri (simüle edilmiş - gerçekte API'den gelecek)
            const startDebtTL = (row.USD_BORC * startUsdRate) + (row.EURO_BORC * startEurRate) + row.TL_BORC;
            const startReceivableTL = (row.USD_ALACAK * startUsdRate) + (row.EURO_ALACAK * startEurRate) + row.TL_ALACAK;

            // Aylık varyasyon faktörü (simülasyon için)
            const monthlyVariation = 0.9 + (Math.random() * 0.2); // %90-110 arası

            // Ay sonu değerleri (simüle edilmiş)
            const endDebtTL = (row.USD_BORC * monthlyVariation * endUsdRate) +
                              (row.EURO_BORC * monthlyVariation * endEurRate) +
                              (row.TL_BORC * monthlyVariation);
            const endReceivableTL = (row.USD_ALACAK * monthlyVariation * endUsdRate) +
                                   (row.EURO_ALACAK * monthlyVariation * endEurRate) +
                                   (row.TL_ALACAK * monthlyVariation);

            startTotalDebt += startDebtTL;
            startTotalReceivable += startReceivableTL;
            endTotalDebt += endDebtTL;
            endTotalReceivable += endReceivableTL;
        });

        const startNet = startTotalReceivable - startTotalDebt;
        const endNet = endTotalReceivable - endTotalDebt;

        monthlyTrendData.push({
            month: period.name,
            startDate: period.startDate,
            endDate: period.endDate,
            startUsdRate: startUsdRate,
            startEurRate: startEurRate,
            endUsdRate: endUsdRate,
            endEurRate: endEurRate,
            debt: {
                start: startTotalDebt,
                end: endTotalDebt,
                change: endTotalDebt - startTotalDebt
            },
            receivable: {
                start: startTotalReceivable,
                end: endTotalReceivable,
                change: endTotalReceivable - startTotalReceivable
            },
            net: {
                start: startNet,
                end: endNet,
                change: endNet - startNet
            }
        });
    });

    return monthlyTrendData;
}

// Gerçek API implementasyonu için örnek fonksiyon
async function fetchRealMonthlyData() {
    // Bu fonksiyon gerçek projede kullanılmalı
    const periods = [
        { startDate: '2025-01-01', endDate: '2025-01-31' },
        { startDate: '2025-02-01', endDate: '2025-02-28' },
        { startDate: '2025-03-01', endDate: '2025-03-31' },
        { startDate: '2025-04-01', endDate: '2025-04-30' },
        { startDate: '2025-05-01', endDate: '2025-05-31' },
        { startDate: '2025-06-01', endDate: '2025-06-30' }
    ];

    const monthlyData = [];

    for (const period of periods) {
        try {
            // Ay başı verisi
            const startResponse = await fetch(`/cari_bakiye_api?date=${period.startDate}&firmas=${getSelectedFirmas()}&cari_grups=${getSelectedCariGrups()}&cari_turs=${getSelectedCariTurs()}&durums=${getSelectedDurums()}`);
            const startData = await startResponse.json();

            // Ay sonu verisi
            const endResponse = await fetch(`/cari_bakiye_api?date=${period.endDate}&firmas=${getSelectedFirmas()}&cari_grups=${getSelectedCariGrups()}&cari_turs=${getSelectedCariTurs()}&durums=${getSelectedDurums()}`);
            const endData = await endResponse.json();

            if (startData.success && endData.success) {
                const monthName = new Date(period.startDate).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

                monthlyData.push({
                    month: monthName,
                    startDate: period.startDate,
                    endDate: period.endDate,
                    debt: {
                        start: startData.summary.reduce((sum, item) => sum + item.TOPLAM_BORC, 0),
                        end: endData.summary.reduce((sum, item) => sum + item.TOPLAM_BORC, 0)
                    },
                    receivable: {
                        start: startData.summary.reduce((sum, item) => sum + item.TOPLAM_ALACAK, 0),
                        end: endData.summary.reduce((sum, item) => sum + item.TOPLAM_ALACAK, 0)
                    },
                    startUsdRate: startData.summary[0]?.USD_KURU || 0,
                    endUsdRate: endData.summary[0]?.USD_KURU || 0,
                    startEurRate: startData.summary[0]?.EUR_KURU || 0,
                    endEurRate: endData.summary[0]?.EUR_KURU || 0
                });
            }
        } catch (error) {
            console.error(`Ay başı/sonu veri çekme hatası - ${period.startDate}:`, error);
        }
    }

    return monthlyData;
}

// Seçili filtreleri alma yardımcı fonksiyonları
function getSelectedFirmas() {
    const selected = [];
    $('#firma-select input[type="checkbox"]:checked').each(function() {
        selected.push($(this).val());
    });
    return selected.join(',');
}

function getSelectedCariGrups() {
    const selected = [];
    $('#cari-grup-select input[type="checkbox"]:checked').each(function() {
        selected.push($(this).val());
    });
    return selected.join(',');
}

function getSelectedCariTurs() {
    const selected = [];
    $('#cari-tur-select input[type="checkbox"]:checked').each(function() {
        selected.push($(this).val());
    });
    return selected.join(',');
}

function getSelectedDurums() {
    const selected = [];
    $('#durum-select input[type="checkbox"]:checked').each(function() {
        selected.push($(this).val());
    });
    return selected.join(',');
}

// Trend grafiklerini oluşturma fonksiyonu
function createTrendCharts(trendData) {
    if (!trendData || trendData.length === 0) return;

    const months = trendData.map(data => data.month);

    // Borç Trend Grafiği
    const debtTrendElement = document.getElementById('debtTrendChart');
    if (debtTrendElement) {
        new Chart(debtTrendElement, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Ay Başı Borç',
                    data: trendData.map(data => data.debt.start),
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                }, {
                    label: 'Ay Sonu Borç',
                    data: trendData.map(data => data.debt.end),
                    borderColor: '#ee5a52',
                    backgroundColor: 'rgba(238, 90, 82, 0.1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Alacak Trend Grafiği
    const receivableTrendElement = document.getElementById('receivableTrendChart');
    if (receivableTrendElement) {
        new Chart(receivableTrendElement, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Ay Başı Alacak',
                    data: trendData.map(data => data.receivable.start),
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                }, {
                    label: 'Ay Sonu Alacak',
                    data: trendData.map(data => data.receivable.end),
                    borderColor: '#44a08d',
                    backgroundColor: 'rgba(68, 160, 141, 0.1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }

    // Net Durum Trend Grafiği
    const netTrendElement = document.getElementById('netTrendChart');
    if (netTrendElement) {
        new Chart(netTrendElement, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Ay Başı Net Durum',
                    data: trendData.map(data => data.net.start),
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    borderRadius: 5
                }, {
                    label: 'Ay Sonu Net Durum',
                    data: trendData.map(data => data.net.end),
                    backgroundColor: 'rgba(118, 75, 162, 0.6)',
                    borderColor: '#764ba2',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return formatMoney(value) + ' ₺';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw) + ' ₺';
                            }
                        }
                    }
                }
            }
        });
    }
}

// Trend tablolarını doldurma fonksiyonu
function populateTrendTables(trendData) {
    if (!trendData || trendData.length === 0) return;

    // Borç Trend Tablosu
    const debtTrendBody = document.getElementById('debtTrendBody');
    if (debtTrendBody) {
        debtTrendBody.innerHTML = '';
        trendData.forEach(data => {
            const changeClass = data.debt.change > 0 ? 'trend-negative' : data.debt.change < 0 ? 'trend-positive' : 'trend-neutral';
            const changeIcon = data.debt.change > 0 ? '↗' : data.debt.change < 0 ? '↘' : '→';

            // Kur değişimi hesapla
            const kurEtkisi = ((data.endUsdRate - data.startUsdRate) + (data.endEurRate - data.startEurRate)) / 2;
            const kurEtkisiClass = kurEtkisi > 0 ? 'trend-negative' : kurEtkisi < 0 ? 'trend-positive' : 'trend-neutral';
            const kurEtkisiIcon = kurEtkisi > 0 ? '↗' : kurEtkisi < 0 ? '↘' : '→';

            const row = `
                <tr>
                    <td><strong>${data.month.split(' ')[0]}</strong></td>
                    <td>${formatMoney(data.debt.start)} ₺</td>
                    <td>${formatMoney(data.debt.end)} ₺</td>
                    <td class="${changeClass}">${changeIcon} ${formatMoney(Math.abs(data.debt.change))} ₺</td>
                    <td class="${kurEtkisiClass}" title="USD: ${data.startUsdRate.toFixed(4)}→${data.endUsdRate.toFixed(4)}, EUR: ${data.startEurRate.toFixed(4)}→${data.endEurRate.toFixed(4)}">
                        ${kurEtkisiIcon} ${Math.abs(kurEtkisi).toFixed(3)} ₺
                    </td>
                </tr>
            `;
            debtTrendBody.innerHTML += row;
        });
    }

    // Alacak Trend Tablosu
    const receivableTrendBody = document.getElementById('receivableTrendBody');
    if (receivableTrendBody) {
        receivableTrendBody.innerHTML = '';
        trendData.forEach(data => {
            const changeClass = data.receivable.change > 0 ? 'trend-positive' : data.receivable.change < 0 ? 'trend-negative' : 'trend-neutral';
            const changeIcon = data.receivable.change > 0 ? '↗' : data.receivable.change < 0 ? '↘' : '→';

            // Kur değişimi hesapla
            const kurEtkisi = ((data.endUsdRate - data.startUsdRate) + (data.endEurRate - data.startEurRate)) / 2;
            const kurEtkisiClass = kurEtkisi > 0 ? 'trend-positive' : kurEtkisi < 0 ? 'trend-negative' : 'trend-neutral';
            const kurEtkisiIcon = kurEtkisi > 0 ? '↗' : kurEtkisi < 0 ? '↘' : '→';

            const row = `
                <tr>
                    <td><strong>${data.month.split(' ')[0]}</strong></td>
                    <td>${formatMoney(data.receivable.start)} ₺</td>
                    <td>${formatMoney(data.receivable.end)} ₺</td>
                    <td class="${changeClass}">${changeIcon} ${formatMoney(Math.abs(data.receivable.change))} ₺</td>
                    <td class="${kurEtkisiClass}" title="USD: ${data.startUsdRate.toFixed(4)}→${data.endUsdRate.toFixed(4)}, EUR: ${data.startEurRate.toFixed(4)}→${data.endEurRate.toFixed(4)}">
                        ${kurEtkisiIcon} ${Math.abs(kurEtkisi).toFixed(3)} ₺
                    </td>
                </tr>
            `;
            receivableTrendBody.innerHTML += row;
        });
    }

    // Net Durum Trend Tablosu
    const netTrendBody = document.getElementById('netTrendBody');
    if (netTrendBody) {
        netTrendBody.innerHTML = '';
        trendData.forEach(data => {
            const changeClass = data.net.change > 0 ? 'trend-positive' : data.net.change < 0 ? 'trend-negative' : 'trend-neutral';
            const changeIcon = data.net.change > 0 ? '↗' : data.net.change < 0 ? '↘' : '→';

            // Net durum için kur etkisi
            const kurEtkisi = ((data.endUsdRate - data.startUsdRate) + (data.endEurRate - data.startEurRate)) / 2;
            const kurEtkisiClass = Math.abs(kurEtkisi) > 0.5 ? 'trend-negative' : 'trend-neutral';
            const kurEtkisiIcon = Math.abs(kurEtkisi) > 0.5 ? '⚠' : '→';

            const row = `
                <tr>
                    <td><strong>${data.month.split(' ')[0]}</strong></td>
                    <td>${formatMoney(data.net.start)} ₺</td>
                    <td>${formatMoney(data.net.end)} ₺</td>
                    <td class="${changeClass}">${changeIcon} ${formatMoney(Math.abs(data.net.change))} ₺</td>
                    <td class="${kurEtkisiClass}" title="Ay içi ortalama kur değişimi">
                        ${kurEtkisiIcon} ${Math.abs(kurEtkisi).toFixed(3)} ₺
                    </td>
                </tr>
            `;
            netTrendBody.innerHTML += row;
        });
    }
}
</script>
{% endblock %}