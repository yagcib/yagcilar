{% extends "base_layout.html" %}

{% block title %}Fatura Onay{% endblock %}

{% block head %}

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .table-responsive {
        margin-top: 20px;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .btn-action {
        margin-right: 5px;
    }
    .badge-status {
        font-size: 12px;
        padding: 5px 8px;
    }
    .badge-waiting {
        background-color: #ffc107;
        color: #212529;
    }
    .badge-approved {
        background-color: #28a745;
        color: #fff;
    }
    .dataTables_filter {
        margin-bottom: 10px;
    }
    .action-buttons {
        white-space: nowrap;
    }
    /* Select2 custom styling */
    .select2-container--default .select2-selection--single {
        height: 34px;
        padding: 3px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 32px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 24px;
        padding-left: 0;
    }
    .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .select2-container--default .select2-dropdown {
        border-color: #80bdff;
    }
    /* Cari ismi highlight */
    .cari-ismi-highlight {
        font-weight: 500;
        color: #0056b3;
    }
    /* DataTable hücre genişlikleri */
    #faturaTable th, #faturaTable td {
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Fatura Onay Listesi</h5>
                <a href="{{ url_for('fatura_onay_ekle') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yeni Fatura Ekle
                </a>
            </div>
            <div class="card-body">
                <!-- Filter section -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterFaturaNo">Fatura No</label>
                                <input type="text" class="form-control form-control-sm" id="filterFaturaNo" placeholder="Fatura numarası">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterFirma">Firma</label>
                                <select class="form-select form-select-sm" id="filterFirma">
                                    <option value="">Tümü</option>
                                    <option value="YDÇ">YDÇ</option>
                                    <option value="Yağcılar">Yağcılar</option>
                                    <option value="Star Yağcılar">Star Yağcılar</option>
                                    <option value="Beymaş">Beymaş</option>
                                    <option value="Alya">Alya</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterCariIsmi">Cari İsmi</label>
                                <select class="form-control form-control-sm" id="filterCariIsmi">
                                    <option value="">Tümü</option>
                                    {% for cari in cari_list_unique %}
                                        <option value="{{ cari }}">{{ cari }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterOdemeDurumu">Ödeme Durumu</label>
                                <select class="form-select form-select-sm" id="filterOdemeDurumu">
                                    <option value="">Tümü</option>
                                    <option value="Ödeme Bekliyor">Ödeme Bekliyor</option>
                                    <option value="Ödendi">Ödendi</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 d-flex justify-content-end">
                            <button type="button" class="btn btn-primary btn-sm me-2" id="btnFilter">
                                <i class="fas fa-filter"></i> Filtrele
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnClearFilter">
                                <i class="fas fa-undo"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data table -->
                <div class="table-responsive">
                    <table id="faturaTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Fatura No</th>
                                <th>Tarih</th>
                                <th>Firma</th>
                                <th>Cari İsmi</th>
                                <th>Vade (Gün)</th>
                                <th>Oluşturan</th>
                                <th>Ödeme Durumu</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fatura in faturalar %}
                            <tr>
                                <td>{{ fatura.fatura_no }}</td>
                                <td>{{ fatura.tarih }}</td>
                                <td>{{ fatura.firma }}</td>
                                <td class="cari-ismi-cell">{% if fatura.cari_ismi %}{{ fatura.cari_ismi }}{% else %}-{% endif %}</td>
                                <td>{{ fatura.vade }}</td>
                                <td>{{ fatura.olusturan_kullanici_ad }}</td>
                                <td>
                                    {% if fatura.odeme_yapildi %}
                                    <span class="badge badge-status badge-approved">Ödendi</span>
                                    {% else %}
                                    <span class="badge badge-status badge-waiting">Ödeme Bekliyor</span>
                                    {% endif %}
                                </td>
                                <td class="action-buttons">
                                    <a href="{{ url_for('fatura_onay_detay', fatura_id=fatura.fatura_id) }}" class="btn btn-sm btn-info btn-action">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not fatura.odeme_yapildi or is_admin or user_logoyetki == 1 %}
                                    <a href="{{ url_for('fatura_onay_detay', fatura_id=fatura.fatura_id) }}" class="btn btn-sm btn-warning btn-action">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger btn-action btn-delete" data-id="{{ fatura.fatura_id }}" data-fatura-no="{{ fatura.fatura_no }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}

                                    {% if not fatura.odeme_yapildi and (is_admin or user_logoyetki == 1) %}
                                    <button type="button" class="btn btn-sm btn-success btn-action btn-approve" data-id="{{ fatura.fatura_id }}" data-fatura-no="{{ fatura.fatura_no }}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fatura Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bu faturayı silmek istediğinizden emin misiniz?</p>
                <p><strong id="deleteFaturaNo"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Sil</button>
            </div>
        </div>
    </div>
</div>

<!-- Approve Confirmation Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ödeme Onay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bu fatura için ödeme yapıldığını onaylıyor musunuz?</p>
                <p><strong id="approveFaturaNo"></strong></p>
                <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Bu işlem geri alınamaz!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Onayla</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Select2 kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for cari filter
    $('#filterCariIsmi').select2({
        placeholder: "Cari ismi filtrele",
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "Sonuç bulunamadı.";
            }
        }
    });

    // Initialize DataTable
    var table = $('#faturaTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json"
        },
        "responsive": true,
        "order": [[1, "desc"]], // Sort by date desc
        "pageLength": 25,
        "dom": 'Bfrtip',
        "buttons": [
            'copy', 'excel', 'pdf', 'print'
        ]
    });

    // Cari isimlerini vurgula
    $('.cari-ismi-cell').each(function() {
        var text = $(this).text().trim();
        if (text && text !== '-') {
            $(this).addClass('cari-ismi-highlight');
        }
    });

    // Custom filtering function - improved version that properly handles HTML content
    $.fn.dataTable.ext.search.push(
        function(settings, searchData, dataIndex, rowData, counter) {
            // Get filter values
            var faturaNo = $('#filterFaturaNo').val().toLowerCase();
            var firma = $('#filterFirma').val();
            var cariIsmi = $('#filterCariIsmi').val();
            var odemeDurumu = $('#filterOdemeDurumu').val();

            // Get row data
            var rowFaturaNo = searchData[0].toLowerCase();
            var rowFirma = searchData[2];
            var rowCariIsmi = searchData[3].trim();
            var rowOdemeDurumuHTML = searchData[6]; // This is HTML content

            // Extract text from HTML for payment status
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = rowOdemeDurumuHTML;
            var rowOdemeDurumu = tempDiv.textContent.trim();

            // Perform matching - using 'includes' for text fields to allow partial matches
            var faturaNoMatch = faturaNo === '' || rowFaturaNo.includes(faturaNo);
            var firmaMatch = firma === '' || rowFirma === firma;
            var cariIsmiMatch = cariIsmi === '' || rowCariIsmi === cariIsmi || (rowCariIsmi.toLowerCase().includes(cariIsmi.toLowerCase()));
            var odemeDurumuMatch = odemeDurumu === '' || rowOdemeDurumu === odemeDurumu;

            return faturaNoMatch && firmaMatch && cariIsmiMatch && odemeDurumuMatch;
        }
    );

    // Filter button click
    $('#btnFilter').click(function() {
        table.draw();
    });

    // Clear filter button click
    $('#btnClearFilter').click(function() {
        $('#filterFaturaNo').val('');
        $('#filterFirma').val('');
        $('#filterCariIsmi').val(null).trigger('change');
        $('#filterOdemeDurumu').val('');
        table.draw();
    });

    // Delete button click
    $('.btn-delete').click(function() {
        var faturaId = $(this).data('id');
        var faturaNo = $(this).data('fatura-no');

        $('#deleteFaturaNo').text(faturaNo);
        $('#confirmDelete').data('id', faturaId);
        $('#deleteModal').modal('show');
    });

    // Confirm delete
    $('#confirmDelete').click(function() {
        var faturaId = $(this).data('id');

        $.ajax({
            url: '/fatura-onay/delete/' + faturaId,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    $('#deleteModal').modal('hide');
                    // Show success message
                    alert(response.message);
                    // Reload page
                    window.location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            }
        });
    });

    // Approve button click
    $('.btn-approve').click(function() {
        var faturaId = $(this).data('id');
        var faturaNo = $(this).data('fatura-no');

        $('#approveFaturaNo').text(faturaNo);
        $('#confirmApprove').data('id', faturaId);
        $('#approveModal').modal('show');
    });

    // Confirm approve
    $('#confirmApprove').click(function() {
        var faturaId = $(this).data('id');

        $.ajax({
            url: '/fatura-onay/approve/' + faturaId,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    $('#approveModal').modal('hide');
                    // Show success message
                    alert(response.message);
                    // Reload page
                    window.location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            }
        });
    });
});
</script>
{% endblock %}