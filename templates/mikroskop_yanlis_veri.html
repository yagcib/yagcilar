{% extends "base_layout.html" %}

{% block title %}Mikroskop Yanlış Veri Kontrolü{% endblock %}

{% block head %}
<style>
    .hatali-veri {
        background-color: #f8d7da !important;
        color: #721c24 !important;
    }
    .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card-header {
        font-weight: bold;
    }
    .btn-action {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-microscope"></i> Mikroskop Yanlış Veri Kontrolü</h2>
        <span class="badge bg-danger">{{ yanlis_veri_sayisi }} Hatalı Kayıt</span>
    </div>

    <!-- Filtre Kontrolleri ve Bilgiler -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <i class="fas fa-filter"></i> Filtre Kontrolleri
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col">
                    <button id="btnYanlisVeriler" class="btn btn-danger me-2">
                        <i class="fas fa-exclamation-triangle"></i> Yanlış Verileri Göster
                    </button>
                    <button id="btnFiltreTemizle" class="btn btn-secondary">
                        <i class="fas fa-broom"></i> Filtreyi Temizle
                    </button>
                </div>
            </div>


        </div>
    </div>

    <!-- Veri Tablosu -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <i class="fas fa-table"></i> Üretim Verileri
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="datatable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>İş Emri</th>
                            <th>Cari Adı</th>
                            <th>Parça Kodu</th>
                            <th>Parça Adı</th>
                            <th>Adet</th>
                            <th>Brüt KG</th>
                            <th>Fire KG</th>
                            <th>Net KG</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr{% if row.HATALI %} class="hatali-veri"{% endif %}>
                            <td>{{ row.ID }}</td>
                            <td>{{ row.IS_EMRI }}</td>
                            <td>{{ row.CARI_ADI }}</td>
                            <td>{{ row.PARCA_KODU }}</td>
                            <td>{{ row.PARCA_ADI }}</td>
                            <td>{{ row.ADET }}</td>
                            <td>{{ "%.2f"|format(row.BRUT_KG) }}</td>
                            <td>{{ "%.2f"|format(row.FIRE_KG) }}</td>
                            <td>{{ "%.2f"|format(row.NET_KG) }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-edit"
                                        data-id="{{ row.ID }}"
                                        data-is-emri="{{ row.IS_EMRI }}"
                                        data-cari-adi="{{ row.CARI_ADI }}"
                                        data-parca-kodu="{{ row.PARCA_KODU }}"
                                        data-parca-adi="{{ row.PARCA_ADI }}"
                                        data-adet="{{ row.ADET }}"
                                        data-brut-kg="{{ row.BRUT_KG }}"
                                        data-fire-kg="{{ row.FIRE_KG }}"
                                        data-net-kg="{{ row.NET_KG }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal">
                                    <i class="fas fa-edit"></i> Düzenle
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Veri Düzenleme Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editModalLabel"><i class="fas fa-edit"></i> Veri Düzenleme</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="txtID" name="id">

                    <div class="mb-3">
                        <label for="txtIsEmri" class="form-label">İş Emri</label>
                        <input type="text" class="form-control" id="txtIsEmri" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="txtCariAdi" class="form-label">Cari Adı</label>
                        <input type="text" class="form-control" id="txtCariAdi" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="txtParcaKodu" class="form-label">Parça Kodu</label>
                            <input type="text" class="form-control" id="txtParcaKodu" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="txtAdet" class="form-label">Adet</label>
                            <input type="number" class="form-control" id="txtAdet" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="txtParcaAdi" class="form-label">Parça Adı</label>
                        <input type="text" class="form-control" id="txtParcaAdi" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="txtBrut" class="form-label">Brüt KG</label>
                            <input type="number" class="form-control" id="txtBrut" name="brut_kg" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="txtFire" class="form-label">Fire KG</label>
                            <input type="number" class="form-control" id="txtFire" name="fire_kg" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="txtNet" class="form-label">Net KG</label>
                            <input type="number" class="form-control" id="txtNet" name="net_kg" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="btnGuncelle">
                    <i class="fas fa-save"></i> Güncelle
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // DataTable'ı başlat
    var table = $('#datatable').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json'
        },
        order: [[0, 'desc']],
        pageLength: 25,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'excel', 'pdf', 'print'
        ]
    });

    // Yanlış verileri göster butonu
    $('#btnYanlisVeriler').on('click', function() {
        table.search('').draw();

        // DataTables API kullanarak filtreleme
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                return $(table.row(dataIndex).node()).hasClass('hatali-veri');
            }
        );

        table.draw();

        // Filtreyi temizleyin
        $.fn.dataTable.ext.search.pop();
    });

    // Filtreyi temizle butonu
    $('#btnFiltreTemizle').on('click', function() {
        table.search('').draw();
    });

    // Düzenle butonları için olay dinleyici - Modal'ı açacak
    $('#datatable').on('click', '.btn-edit', function() {
        var button = $(this);

        // Form alanlarını doldur
        $('#txtID').val(button.data('id'));
        $('#txtIsEmri').val(button.data('is-emri'));
        $('#txtCariAdi').val(button.data('cari-adi'));
        $('#txtParcaKodu').val(button.data('parca-kodu'));
        $('#txtParcaAdi').val(button.data('parca-adi'));
        $('#txtAdet').val(button.data('adet'));
        $('#txtBrut').val(button.data('brut-kg'));
        $('#txtFire').val(button.data('fire-kg'));
        $('#txtNet').val(button.data('net-kg'));
    });

    // Güncelle butonu işlevi
    $('#btnGuncelle').on('click', function() {
        var id = $('#txtID').val();
        var brutKg = $('#txtBrut').val();
        var netKg = $('#txtNet').val();

        // Validasyon kontrolleri
        if (!id) {
            alert('Lütfen güncellenecek bir kayıt seçin.');
            return;
        }

        if (!brutKg || !netKg) {
            alert('Brüt KG ve Net KG alanları zorunludur.');
            return;
        }

        if (parseFloat(netKg) > parseFloat(brutKg)) {
            alert('Net KG, Brüt KG\'dan büyük olamaz.');
            return;
        }

        // AJAX ile güncelleme yap
        $.ajax({
            url: '/mikroskop-yanlis-veri/guncelle',
            type: 'POST',
            data: $('#editForm').serialize(),
            success: function(response) {
                if (response.success) {
                    // Modalı kapat
                    $('#editModal').modal('hide');

                    // Başarılı mesajı göster
                    alert(response.message);

                    // Sayfayı yenile
                    window.location.reload();
                } else {
                    // Hata mesajı göster
                    alert('Hata: ' + response.message);
                }
            },
            error: function() {
                alert('Sunucu ile iletişim sırasında bir hata oluştu.');
            }
        });
    });

    // Brüt ve Fire değişince Net'i hesapla
    $('#txtBrut, #txtFire').on('input', function() {
        var brutKg = parseFloat($('#txtBrut').val()) || 0;
        var fireKg = parseFloat($('#txtFire').val()) || 0;

        var netKg = brutKg - fireKg;
        if (netKg < 0) netKg = 0;

        $('#txtNet').val(netKg.toFixed(2));
    });

    // Net değişince Fire'ı hesapla
    $('#txtNet').on('input', function() {
        var brutKg = parseFloat($('#txtBrut').val()) || 0;
        var netKg = parseFloat($('#txtNet').val()) || 0;

        if (netKg > brutKg) {
            alert('Net KG, Brüt KG\'dan büyük olamaz.');
            $(this).val(brutKg.toFixed(2));
            netKg = brutKg;
        }

        var fireKg = brutKg - netKg;
        $('#txtFire').val(fireKg.toFixed(2));
    });

    // Modal kapandığında formu temizle
    $('#editModal').on('hidden.bs.modal', function () {
        $('#editForm')[0].reset();
        $('#txtID').val('');
    });
});
</script>
{% endblock %}