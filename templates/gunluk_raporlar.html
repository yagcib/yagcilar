{% extends "base_layout.html" %}

{% block title %}Günlük Raporlar - Yagcilar Holding{% endblock %}

{% block head %}
<style>
    .main-tabs {
        border-bottom: 2px solid #282965;
        margin-bottom: 20px;
    }
    
    .main-tabs .nav-link {
        color: #282965;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        margin-right: 10px;
    }
    
    .main-tabs .nav-link.active {
        color: #282965;
        background-color: transparent;
        border-bottom-color: #282965;
    }
    
    .main-tabs .nav-link:hover {
        color: #1a1a4a;
        border-bottom-color: #1a1a4a;
    }
    
    .sub-tabs {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
    }
    
    .sub-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-right: 5px;
        margin-bottom: 5px;
        padding: 8px 15px;
    }
    
    .sub-tabs .nav-link.active {
        color: #fff;
        background-color: #282965;
        border-color: #282965;
    }
    
    .sub-tabs .nav-link:hover {
        color: #282965;
        border-color: #282965;
    }
    
    .content-area {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-height: 400px;
    }
    
    .email-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #dee2e6;
    }
    
    .email-section h5 {
        color: #282965;
        margin-bottom: 15px;
    }
    
    .btn-send-email {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
        font-weight: 600;
    }
    
    .btn-send-email:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    .report-table {
        margin-top: 20px;
    }
    
    .report-table th {
        background-color: #282965;
        color: white;
        border: none;
    }
    
    .report-table td {
        border-color: #dee2e6;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .email-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
        display: none;
    }
    
    .email-status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .email-status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .loading-content .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .data-loaded {
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    .data-loading {
        opacity: 0.6;
        transition: opacity 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Yükleme Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <h5 class="mt-3 mb-2">Veriler Yükleniyor</h5>
        <p class="text-muted">Tüm rapor verileri çekiliyor, lütfen bekleyin...</p>
        <div class="progress mt-3" style="height: 6px;">
            <div id="loadingProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-chart-line"></i> Günlük Raporlar
        </h2>

        <!-- Ana Sekmeler -->
        <ul class="nav nav-tabs main-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ydc-metal-tab" data-bs-toggle="tab" data-bs-target="#ydc-metal" type="button" role="tab">
                    <i class="fas fa-industry"></i> Ydç Metal
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="star-yagcilar-tab" data-bs-toggle="tab" data-bs-target="#star-yagcilar" type="button" role="tab">
                    <i class="fas fa-star"></i> Star Yağcılar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="yagcilar-metal-tab" data-bs-toggle="tab" data-bs-target="#yagcilar-metal" type="button" role="tab">
                    <i class="fas fa-cogs"></i> Yağcılar Metal Endüstri
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="genel-tab" data-bs-toggle="tab" data-bs-target="#genel" type="button" role="tab">
                    <i class="fas fa-building"></i> Genel
                </button>
            </li>
        </ul>

        <!-- Sekme İçerikleri -->
        <div class="tab-content data-loading" id="mainTabContent">

            <!-- Ydç Metal Sekmesi -->
            <div class="tab-pane fade show active" id="ydc-metal" role="tabpanel">
                <ul class="nav nav-pills sub-tabs" id="ydcSubTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="ydc-sevkiyat-tab" data-bs-toggle="tab" data-bs-target="#ydc-sevkiyat" type="button" role="tab">
                            Sevkiyat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-satis-tab" data-bs-toggle="tab" data-bs-target="#ydc-satis" type="button" role="tab">
                            Satış
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-petrol-tab" data-bs-toggle="tab" data-bs-target="#ydc-petrol" type="button" role="tab">
                            Petrol
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-lazer-planlama-tab" data-bs-toggle="tab" data-bs-target="#ydc-lazer-planlama" type="button" role="tab">
                            Lazer Planlama
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-kaynakhane-tab" data-bs-toggle="tab" data-bs-target="#ydc-kaynakhane" type="button" role="tab">
                            Kaynakhane
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-kalite-tab" data-bs-toggle="tab" data-bs-target="#ydc-kalite" type="button" role="tab">
                            Kalite
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-isg-tab" data-bs-toggle="tab" data-bs-target="#ydc-isg" type="button" role="tab">
                            İSG
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-insankaynaklari-tab" data-bs-toggle="tab" data-bs-target="#ydc-insankaynaklari" type="button" role="tab">
                            İnsan Kaynakları
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-ihracat-tab" data-bs-toggle="tab" data-bs-target="#ydc-ihracat" type="button" role="tab">
                            İhracat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-lazer-gunduz-tab" data-bs-toggle="tab" data-bs-target="#ydc-lazer-gunduz" type="button" role="tab">
                            Lazer Gündüz
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-lazer-gece-tab" data-bs-toggle="tab" data-bs-target="#ydc-lazer-gece" type="button" role="tab">
                            Lazer Gece
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ydc-depo-tab" data-bs-toggle="tab" data-bs-target="#ydc-depo" type="button" role="tab">
                            Depo
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="ydcSubTabContent">
                    <!-- Sevkiyat sekmesi -->
                    <div class="tab-pane fade show active" id="ydc-sevkiyat" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-shipping-fast"></i> Ydç Metal - Sevkiyat</h4>
                            <div id="ydc-sevkiyat-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>OLUŞTURMA SAATİ</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>MİKTAR (KG)</th>
                                            <th>MİKTAR (ADET)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-sevkiyat-tbody">
                                        <tr><td colspan="8" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Satış sekmesi -->
                    <div class="tab-pane fade" id="ydc-satis" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-chart-bar"></i> Ydç Metal - Satış</h4>
                            <div id="ydc-satis-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-satis-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Petrol sekmesi -->
                    <div class="tab-pane fade" id="ydc-petrol" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-gas-pump"></i> Ydç Metal - Petrol</h4>
                            <div id="ydc-petrol-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-petrol-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Lazer Planlama sekmesi -->
                    <div class="tab-pane fade" id="ydc-lazer-planlama" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-drafting-compass"></i> Ydç Metal - Lazer Planlama</h4>
                            <div id="ydc-lazer-planlama-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-lazer-planlama-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Kaynakhane sekmesi -->
                    <div class="tab-pane fade" id="ydc-kaynakhane" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-fire"></i> Ydç Metal - Kaynakhane</h4>
                            <div id="ydc-kaynakhane-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>SORUMLU</th>
                                            <th>OLUŞTURMA SAATİ</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>MİKTAR (ADET)</th>
                                            <th>MİKTAR (KG)</th>
                                            <th>SÜRE (SAAT)</th>
                                            <th>YARINKİ HEDEF</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-kaynakhane-tbody">
                                        <tr><td colspan="10" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Kalite sekmesi -->
                    <div class="tab-pane fade" id="ydc-kalite" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-check-circle"></i> Ydç Metal - Kalite</h4>
                            <div id="ydc-kalite-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-kalite-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- İSG sekmesi -->
                    <div class="tab-pane fade" id="ydc-isg" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-hard-hat"></i> Ydç Metal - İSG</h4>
                            <div id="ydc-isg-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-isg-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- İnsan Kaynakları sekmesi -->
                    <div class="tab-pane fade" id="ydc-insankaynaklari" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-users"></i> Ydç Metal - İnsan Kaynakları</h4>
                            <div id="ydc-insankaynaklari-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>LOKASYON</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-insankaynaklari-tbody">
                                        <tr><td colspan="6" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- İhracat sekmesi -->
                    <div class="tab-pane fade" id="ydc-ihracat" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-ship"></i> Ydç Metal - İhracat</h4>
                            <div id="ydc-ihracat-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-ihracat-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Lazer Gündüz sekmesi -->
                    <div class="tab-pane fade" id="ydc-lazer-gunduz" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-sun"></i> Ydç Metal - Lazer Gündüz</h4>
                            <div id="ydc-lazer-gunduz-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>ADI SOYADI</th>
                                            <th>OLUŞTURMA SAATİ</th>
                                            <th>VARDİYA</th>
                                            <th>CARİ/PROJE</th>
                                            <th>MAKİNE</th>
                                            <th>PERSONEL</th>
                                            <th>MİKTAR (KG)</th>
                                            <th>SÜRE (SAAT)</th>
                                            <th>KAYIP (SAAT)</th>
                                            <th>DETAY</th>
                                            <th>YARINKİ HEDEF</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-lazer-gunduz-tbody">
                                        <tr><td colspan="12" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Lazer Gece sekmesi -->
                    <div class="tab-pane fade" id="ydc-lazer-gece" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-moon"></i> Ydç Metal - Lazer Gece</h4>
                            <div id="ydc-lazer-gece-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>ADI SOYADI</th>
                                            <th>OLUŞTURMA SAATİ</th>
                                            <th>VARDİYA</th>
                                            <th>CARİ/PROJE</th>
                                            <th>MAKİNE</th>
                                            <th>PERSONEL</th>
                                            <th>MİKTAR (KG)</th>
                                            <th>SÜRE (SAAT)</th>
                                            <th>KAYIP (SAAT)</th>
                                            <th>DETAY</th>
                                            <th>YARINKİ HEDEF</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-lazer-gece-tbody">
                                        <tr><td colspan="12" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Depo sekmesi -->
                    <div class="tab-pane fade" id="ydc-depo" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-warehouse"></i> Ydç Metal - Depo</h4>
                            <div id="ydc-depo-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ydc-depo-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Star Yağcılar Sekmesi -->
            <div class="tab-pane fade" id="star-yagcilar" role="tabpanel">
                <ul class="nav nav-pills sub-tabs" id="starSubTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="star-uretim-tab" data-bs-toggle="tab" data-bs-target="#star-uretim" type="button" role="tab">
                            Üretim
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-satinalma-tab" data-bs-toggle="tab" data-bs-target="#star-satinalma" type="button" role="tab">
                            Satın Alma
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-proje-tab" data-bs-toggle="tab" data-bs-target="#star-proje" type="button" role="tab">
                            Proje Ekibi
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-kalite-tab" data-bs-toggle="tab" data-bs-target="#star-kalite" type="button" role="tab">
                            Kalite
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-ik-tab" data-bs-toggle="tab" data-bs-target="#star-ik" type="button" role="tab">
                            İnsan Kaynakları
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-ihracat-tab" data-bs-toggle="tab" data-bs-target="#star-ihracat" type="button" role="tab">
                            İhracat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="star-depo-tab" data-bs-toggle="tab" data-bs-target="#star-depo" type="button" role="tab">
                            Depo
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="starSubTabContent">
                    <div class="tab-pane fade show active" id="star-uretim" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-industry"></i> Star Yağcılar - Üretim</h4>
                            <div id="star-uretim-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>SORUMLU</th>
                                            <th>MİKTAR (KG)</th>
                                            <th>MİKTAR (ADET)</th>
                                            <th>YARINKİ HEDEF</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-uretim-tbody">
                                        <tr><td colspan="9" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-satinalma" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-shopping-cart"></i> Star Yağcılar - Satın Alma</h4>
                            <div id="star-satinalma-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-satinalma-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-proje" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-project-diagram"></i> Star Yağcılar - Proje Ekibi</h4>
                            <div id="star-proje-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>DETAY</th>
                                            <th>YARINKİ HEDEF</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-proje-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-kalite" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-check-circle"></i> Star Yağcılar - Kalite</h4>
                            <div id="star-kalite-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-kalite-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-ik" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-users"></i> Star Yağcılar - İnsan Kaynakları</h4>
                            <div id="star-ik-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>LOKASYON</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-ik-tbody">
                                        <tr><td colspan="6" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-ihracat" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-ship"></i> Star Yağcılar - İhracat</h4>
                            <div id="star-ihracat-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-ihracat-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="star-depo" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-warehouse"></i> Star Yağcılar - Depo</h4>
                            <div id="star-depo-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                        </tr>
                                    </thead>
                                    <tbody id="star-depo-tbody">
                                        <tr><td colspan="5" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yağcılar Metal Endüstri Sekmesi -->
            <div class="tab-pane fade" id="yagcilar-metal" role="tabpanel">
                <ul class="nav nav-pills sub-tabs" id="yagcilarSubTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="yagcilar-satis-tab" data-bs-toggle="tab" data-bs-target="#yagcilar-satis" type="button" role="tab">
                            Satış
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="yagcilarSubTabContent">
                    <div class="tab-pane fade show active" id="yagcilar-satis" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-chart-bar"></i> Yağcılar Metal Endüstri - Satış</h4>
                            <div id="yagcilar-satis-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>AD SOYAD</th>
                                            <th>CARİ/PROJE</th>
                                            <th>KONU</th>
                                            <th>DETAY</th>
                                            <th>TUTAR (TL)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yagcilar-satis-tbody">
                                        <tr><td colspan="6" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Genel Sekmesi -->
            <div class="tab-pane fade" id="genel" role="tabpanel">
                <ul class="nav nav-pills sub-tabs" id="genelSubTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="genel-kantar-tab" data-bs-toggle="tab" data-bs-target="#genel-kantar" type="button" role="tab">
                            Kantar
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="genel-lastik-tab" data-bs-toggle="tab" data-bs-target="#genel-lastik" type="button" role="tab">
                            Lastik
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="genel-pesin-tab" data-bs-toggle="tab" data-bs-target="#genel-pesin" type="button" role="tab">
                            Peşin Kesilen Fatura
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="genel-satis-ekibi-tab" data-bs-toggle="tab" data-bs-target="#genel-satis-ekibi" type="button" role="tab">
                            Satış Ekibi Kesilen Faturalar
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="genelSubTabContent">
                    <!-- Kantar Sekmesi -->
                    <div class="tab-pane fade show active" id="genel-kantar" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-weight"></i> Genel - Kantar</h4>
                            <div id="genel-kantar-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>Plaka</th>
                                            <th>ŞOFÖR</th>
                                            <th>CARİ ADI</th>
                                            <th>MALZEME</th>
                                            <th>1. TARTI</th>
                                            <th>2. TARTI</th>
                                            <th>TOPLAM KG</th>
                                            <th>ÜCRET</th>
                                        </tr>
                                    </thead>
                                    <tbody id="genel-kantar-tbody">
                                        <tr><td colspan="9" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Lastik Sekmesi -->
                    <div class="tab-pane fade" id="genel-lastik" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-tire"></i> Genel - Lastik</h4>
                            <div id="genel-lastik-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>SIRA</th>
                                            <th>TARİH</th>
                                            <th>FİŞ NO</th>
                                            <th>CARİ</th>
                                            <th>PLAKA</th>
                                            <th>YAPILAN İŞLEM</th>
                                            <th>ÖDEME</th>
                                            <th>TUTAR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="genel-lastik-tbody">
                                        <tr><td colspan="8" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Peşin Kesilen Fatura Sekmesi -->
                    <div class="tab-pane fade" id="genel-pesin" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-receipt"></i> Genel - Peşin Kesilen Fatura</h4>
                            <div id="genel-pesin-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>Sıra</th>
                                            <th>Firma</th>
                                            <th>Fatura Türü</th>
                                            <th>Fatura Numarası</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Vade</th>
                                            <th>Cari Adı</th>
                                            <th>Toplam Miktar</th>
                                            <th>İşlem Döviz Türü</th>
                                            <th>Tutar</th>
                                            <th>Sorumlu</th>
                                        </tr>
                                    </thead>
                                    <tbody id="genel-pesin-tbody">
                                        <tr><td colspan="11" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Satış Ekibi Kesilen Faturalar Sekmesi -->
                    <div class="tab-pane fade" id="genel-satis-ekibi" role="tabpanel">
                        <div class="content-area">
                            <h4><i class="fas fa-users"></i> Genel - Satış Ekibi Kesilen Faturalar</h4>
                            <div id="genel-satis-ekibi-content">
                                <table class="table table-striped report-table">
                                    <thead>
                                        <tr>
                                            <th>CARİ HESAP ÜNVANI</th>
                                            <th>SİPARİŞ NUMARASI</th>
                                            <th>SİPARİŞ TUTAR</th>
                                            <th>İRSALİYE NUMARASI</th>
                                            <th>FATURA NUMARASI</th>
                                            <th>FATURA VE İRSALİYE TUTAR (TL)</th>
                                            <th>VADE</th>
                                            <th>TOPLAM MİKTAR</th>
                                            <th>BİRİM</th>
                                            <th>TOPLAM NET KG</th>
                                        </tr>
                                    </thead>
                                    <tbody id="genel-satis-ekibi-tbody">
                                        <tr><td colspan="10" class="text-center">Veriler yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- E-posta Gönderme Bölümü -->
        <div class="email-section">
            <h5><i class="fas fa-envelope"></i> Raporu E-posta ile Gönder</h5>
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="emailRecipient" class="form-label">Alıcı E-posta Adresi</label>
                        <input type="email" class="form-control" id="emailRecipient" value="bayramyagci@yagcilar.com.tr" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Konu</label>
                        <input type="text" class="form-control" id="emailSubject" value="Günlük Raporlar - 24.06.2025">
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Mesaj (İsteğe Bağlı)</label>
                        <textarea class="form-control" id="emailMessage" rows="3" placeholder="Ek mesajınızı buraya yazabilirsiniz..."></textarea>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-send-email btn-lg w-100" onclick="sendEmailReport()">
                        <i class="fas fa-paper-plane"></i> Raporu Gönder
                    </button>
                </div>
            </div>
            <div class="email-status" id="emailStatus"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global değişken - tüm veriler
let allReportsData = {};

// Sayfa yüklendiğinde tüm verileri çek
document.addEventListener('DOMContentLoaded', function() {
    loadAllReportsData();
});

// Tüm rapor verilerini tek seferde yükle
function loadAllReportsData() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingProgress = document.getElementById('loadingProgress');
    const mainTabContent = document.getElementById('mainTabContent');

    // Loading'i göster
    loadingOverlay.style.display = 'flex';
    mainTabContent.classList.add('data-loading');

    // Progress bar animasyonu
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        loadingProgress.style.width = progress + '%';
    }, 200);

    // Tüm verileri çek
    fetch('/get-all-daily-reports')
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            loadingProgress.style.width = '100%';

            if (data.success) {
                allReportsData = data.data;

                // Tüm tabloları güncelle
                updateAllTables();

                // Loading'i gizle
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    mainTabContent.classList.remove('data-loading');
                    mainTabContent.classList.add('data-loaded');
                }, 500);

            } else {
                showGlobalError('Veriler yüklenirken hata oluştu: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            showGlobalError('Ağ hatası: ' + error.message);
        });
}

// Tüm tabloları güncelle
function updateAllTables() {
    // YDÇ Metal tabloları
    const ydcTables = [
        'ydc_sevkiyat', 'ydc_satis', 'ydc_petrol', 'ydc_lazer_planlama',
        'ydc_kaynakhane', 'ydc_kalite', 'ydc_isg', 'ydc_insankaynaklari',
        'ydc_ihracat', 'ydc_lazer_gunduz', 'ydc_lazer_gece', 'ydc_depo'
    ];

    ydcTables.forEach(tableKey => {
        const data = allReportsData[tableKey] || [];
        updateYdcTable('#' + tableKey.replace('_', '-'), data);
    });

    // Star Yağcılar tabloları
    const starTables = [
        'star_uretim', 'star_satinalma', 'star_proje', 'star_kalite',
        'star_insankaynaklari', 'star_ihracat', 'star_depo'
    ];

    starTables.forEach(tableKey => {
        const data = allReportsData[tableKey] || [];
        updateStarTable('#' + tableKey.replace('_', '-'), data);
    });

    // Yağcılar Metal Endüstri tabloları
    const yagcilarData = allReportsData['yagcilar_satis'] || [];
    updateYagcilarTable('#yagcilar-satis', yagcilarData);

    // Genel tabloları
    const genelTables = ['genel_lastik', 'genel_kantar', 'genel_pesin', 'genel_satis_ekibi'];

    genelTables.forEach(tableKey => {
        const data = allReportsData[tableKey] || [];
        updateGenelTable('#' + tableKey.replace('_', '-'), data);
    });
}

// YDÇ Metal tablosunu güncelle
function updateYdcTable(tabId, data) {
    const tableBodyId = tabId.replace('#', '') + '-tbody';
    const tbody = document.getElementById(tableBodyId);

    if (!tbody) return;

    if (data && data.length > 0) {
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            let orderedValues = [];

            if (tabId === '#ydc-sevkiyat') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['OLUŞTURMA SAATİ'] || '',
                    row['CARİ/PROJE'] || '', row['KONU'] || '', row['DETAY'] || '',
                    row['MİKTAR (KG)'] || '', row['MİKTAR (ADET)'] || ''
                ];
            } else if (tabId === '#ydc-satis') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-petrol') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-lazer-planlama') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-kaynakhane') {
                orderedValues = [
                    row['SIRA'] || '', row['SORUMLU'] || '', row['OLUŞTURMA SAATİ'] || '',
                    row['CARİ/PROJE'] || '', row['KONU'] || '', row['DETAY'] || '',
                    row['MİKTAR (ADET)'] || '', row['MİKTAR (KG)'] || '',
                    row['SÜRE (SAAT)'] || '', row['YARINKİ HEDEF'] || ''
                ];
            } else if (tabId === '#ydc-kalite') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-isg') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-insankaynaklari') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || '', row['LOKASYON'] || ''
                ];
            } else if (tabId === '#ydc-ihracat') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else if (tabId === '#ydc-lazer-gunduz' || tabId === '#ydc-lazer-gece') {
                orderedValues = [
                    row['SIRA'] || '', row['ADI SOYADI'] || '', row['OLUŞTURMA SAATİ'] || '',
                    row['VARDİYA'] || '', row['CARİ/PROJE'] || '', row['MAKİNE'] || '',
                    row['PERSONEL'] || '', row['MİKTAR (KG)'] || '', row['SÜRE (SAAT)'] || '',
                    row['KAYIP (SAAT)'] || '', row['DETAY'] || '', row['YARINKİ HEDEF'] || ''
                ];
            } else if (tabId === '#ydc-depo') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            } else {
                const keys = Object.keys(row);
                orderedValues = keys.map(key => row[key] || '');
            }

            orderedValues.forEach(cellValue => {
                const td = document.createElement('td');
                td.textContent = cellValue || '-';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı</td></tr>';
    }
}

// Star tablosunu güncelle
function updateStarTable(tabId, data) {
    const tableBodyId = tabId.replace('#', '') + '-tbody';
    const tbody = document.getElementById(tableBodyId);

    if (!tbody) return;

    if (data && data.length > 0) {
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            let orderedValues = [];

            if (tabId === '#star-uretim') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || '', row['SORUMLU'] || '',
                    row['MİKTAR (KG)'] || '', row['MİKTAR (ADET)'] || '', row['YARINKİ HEDEF'] || ''
                ];
            } else if (tabId === '#star-proje') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['DETAY'] || '', row['YARINKİ HEDEF'] || ''
                ];
            } else if (tabId === '#star-ik') {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || '', row['LOKASYON'] || ''
                ];
            } else {
                orderedValues = [
                    row['SIRA'] || '', row['AD SOYAD'] || '', row['CARİ/PROJE'] || '',
                    row['KONU'] || '', row['DETAY'] || ''
                ];
            }

            orderedValues.forEach(cellValue => {
                const td = document.createElement('td');
                td.textContent = cellValue || '-';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı</td></tr>';
    }
}

// Yağcılar tablosunu güncelle
function updateYagcilarTable(tabId, data) {
    const tableBodyId = tabId.replace('#', '') + '-tbody';
    const tbody = document.getElementById(tableBodyId);

    if (!tbody) return;

    if (data && data.length > 0) {
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            const orderedValues = [
                row['SIRA'] || '',
                row['AD SOYAD'] || '',
                row['CARİ/PROJE'] || '',
                row['KONU'] || '',
                row['DETAY'] || '',
                row['TUTAR (TL)'] || ''
            ];

            orderedValues.forEach(cellValue => {
                const td = document.createElement('td');
                td.textContent = cellValue || '-';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Veri bulunamadı</td></tr>';
    }
}

// Genel tablosunu güncelle
function updateGenelTable(tabId, data) {
    const tableBodyId = tabId.replace('#', '') + '-tbody';
    const tbody = document.getElementById(tableBodyId);

    if (!tbody) return;

    if (data && data.length > 0) {
        tbody.innerHTML = '';

        data.forEach(row => {
            const tr = document.createElement('tr');
            let orderedValues = [];

            if (tabId === '#genel-kantar') {
                orderedValues = [
                    row['SIRA'] || '',
                    row['Plaka'] || '',
                    row['ŞOFÖR'] || '',
                    row['CARİ ADI'] || '',
                    row['MALZEME'] || '',
                    row['1. TARTI'] || '',
                    row['2. TARTI'] || '',
                    row['TOPLAM KG'] || '',
                    row['ÜCRET'] || ''
                ];
            } else if (tabId === '#genel-lastik') {
                orderedValues = [
                    row['SIRA'] || '',
                    row['TARİH'] || '',
                    row['FİŞ NO'] || '',
                    row['CARİ'] || '',
                    row['PLAKA'] || '',
                    row['YAPILAN İŞLEM'] || '',
                    row['ÖDEME'] || '',
                    row['TUTAR'] || ''
                ];
            } else if (tabId === '#genel-pesin') {
                orderedValues = [
                    row['Sıra'] || '',
                    row['Firma'] || '',
                    row['Fatura Türü'] || '',
                    row['Fatura Numarası'] || '',
                    row['Fatura Tarihi'] || '',
                    row['Vade'] || '',
                    row['Cari Adı'] || '',
                    row['Toplam Miktar'] || '',
                    row['İşlem Döviz Türü'] || '',
                    row['Tutar'] || '',
                    row['Sorumlu'] || ''
                ];
            } else if (tabId === '#genel-satis-ekibi') {
                orderedValues = [
                    row['CARİ HESAP ÜNVANI'] || '',
                    row['SİPARİŞ NUMARASI'] || '',
                    row['SİPARİŞ TUTAR'] || '',
                    row['İRSALİYE NUMARASI'] || '',
                    row['FATURA NUMARASI'] || '',
                    row['FATURA VE İRSALİYE TUTAR (TL)'] || '',
                    row['VADE'] || '',
                    row['TOPLAM MİKTAR'] || '',
                    row['BİRİM'] || '',
                    row['TOPLAM NET KG'] || ''
                ];
            }

            orderedValues.forEach(cellValue => {
                const td = document.createElement('td');
                td.textContent = cellValue || '-';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    } else {
        let colCount = 9;
        if (tabId === '#genel-lastik') colCount = 8;
        else if (tabId === '#genel-pesin') colCount = 11;
        else if (tabId === '#genel-satis-ekibi') colCount = 10;

        tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center">Veri bulunamadı</td></tr>`;
    }
}

// Global hata gösterme
function showGlobalError(message) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainTabContent = document.getElementById('mainTabContent');

    loadingOverlay.style.display = 'none';
    mainTabContent.classList.remove('data-loading');

    // Tüm tbody'leri hata mesajıyla doldur
    document.querySelectorAll('tbody').forEach(tbody => {
        const colCount = tbody.closest('table').querySelectorAll('thead th').length;
        tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-danger">Hata: ${message}</td></tr>`;
    });
}

// E-posta gönderme fonksiyonu
function sendEmailReport() {
    const recipient = document.getElementById('emailRecipient').value;
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    const statusDiv = document.getElementById('emailStatus');

    const activeMainTab = document.querySelector('#mainTabs .nav-link.active').textContent.trim();
    const activeSubTab = document.querySelector('.sub-tabs .nav-link.active')?.textContent.trim() || '';

    const sendButton = event.target;
    const originalText = sendButton.innerHTML;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';
    sendButton.disabled = true;

    fetch('/send-daily-report-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            recipient: recipient,
            subject: subject,
            message: message,
            activeTab: activeMainTab,
            activeSubTab: activeSubTab,
            reportData: getCurrentTabData()
        })
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                throw new Error('Sunucu beklenmeyen bir yanıt döndürdü. Lütfen tekrar deneyin.');
            });
        }

        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Sunucu hatası: ${response.status}`);
            });
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            statusDiv.className = 'email-status success';
            statusDiv.textContent = 'E-posta başarıyla gönderildi!';
        } else {
            statusDiv.className = 'email-status error';
            statusDiv.textContent = 'E-posta gönderilirken bir hata oluştu: ' + (data.error || 'Bilinmeyen hata');
        }
        statusDiv.style.display = 'block';

        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    })
    .catch(error => {
        statusDiv.className = 'email-status error';
        statusDiv.textContent = 'E-posta gönderilirken bir hata oluştu: ' + error.message;
        statusDiv.style.display = 'block';

        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    })
    .finally(() => {
        sendButton.innerHTML = originalText;
        sendButton.disabled = false;
    });
}

// Aktif sekmenin verilerini al
function getCurrentTabData() {
    try {
        const activeTabPane = document.querySelector('.tab-pane.active .content-area');
        if (!activeTabPane) return null;

        const table = activeTabPane.querySelector('table');
        if (!table) return null;

        const data = [];
        const rows = table.querySelectorAll('tbody tr');
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());

        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
            const rowData = {};
            headers.forEach((header, index) => {
                rowData[header] = cells[index] || '';
            });
            data.push(rowData);
        });

        return {
            headers: headers,
            rows: data
        };
    } catch (error) {
        return {
            headers: [],
            rows: []
        };
    }
}

// DataTables başlatma
$(document).ready(function() {
    // Veriler yüklendikten sonra DataTables'ı başlat
    setTimeout(() => {
        if ($.fn.DataTable) {
            $('.report-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json'
                },
                responsive: true,
                pageLength: 25,
                order: [[0, 'desc']],
                destroy: true
            });
        }
    }, 2000);
});
</script>
{% endblock %}